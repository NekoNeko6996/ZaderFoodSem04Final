<!DOCTYPE html>
<html class="light" lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8"/>
        <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
        <script id="tailwind-config">
            tailwind.config = {
                theme: {extend: {colors: {"nutri-green": "#4CAF50", "chef-orange": "#FF7043", "dark-ink": "#263238", "soft-grey": "#78909C", "smart-mist": "#ECEFF1", "card-white": "#FFFFFF", "smart-white": "#FAFAFA", "error": "#E53935"}, fontFamily: {"display": ["Plus Jakarta Sans", "sans-serif"]}}}
            }
        </script>
    </head>
    <body class="font-display">
        <div th:replace="~{fragments/navbar_auth :: header_nav}"></div>

        <div class="relative flex h-auto min-h-screen w-full flex-col items-center justify-center bg-smart-white p-4">
            <div class="w-full max-w-md">
                <form id="otpForm" th:action="@{/register/step2}" method="POST" class="flex flex-col items-center rounded-xl border border-smart-mist bg-card-white p-6 shadow-lg sm:p-8">

                    <div class="w-full mb-6 flex gap-2">
                        <div class="h-1 flex-1 bg-nutri-green rounded"></div>
                        <div class="h-1 flex-1 bg-nutri-green rounded"></div>
                        <div class="h-1 flex-1 bg-smart-mist rounded"></div>
                    </div>

                    <h1 class="text-dark-ink text-[32px] font-bold pb-2">Verify Email</h1>
                    <p class="text-soft-grey pb-6 text-center">We sent a code to <span class="font-bold text-dark-ink" th:text="${session.regEmail}">your email</span></p>

                    <div th:if="${message}" class="w-full mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded-lg text-sm text-center">
                        <span th:text="${message}"></span>
                    </div>

                    <div th:if="${error}" class="w-full mb-4 p-3 bg-red-100 text-error rounded-lg text-sm text-center" th:text="${error}"></div>

                    <div class="w-full">
                        <label class="flex flex-col items-center">
                            <p class="text-dark-ink text-sm font-medium pb-4">Enter 6-digit Code</p>

                            <input type="hidden" name="otp" id="hiddenOtpInput">

                            <div class="flex gap-2 sm:gap-3 justify-center">
                                <input class="otp-input w-10 h-12 sm:w-12 sm:h-14 border border-smart-mist rounded-lg text-center text-xl sm:text-2xl font-bold text-dark-ink focus:border-nutri-green focus:ring-2 focus:ring-nutri-green/50 outline-none" 
                                       type="text" maxlength="1" pattern="[0-9]*" inputmode="numeric" />
                                <input class="otp-input w-10 h-12 sm:w-12 sm:h-14 border border-smart-mist rounded-lg text-center text-xl sm:text-2xl font-bold text-dark-ink focus:border-nutri-green focus:ring-2 focus:ring-nutri-green/50 outline-none" 
                                       type="text" maxlength="1" pattern="[0-9]*" inputmode="numeric" />
                                <input class="otp-input w-10 h-12 sm:w-12 sm:h-14 border border-smart-mist rounded-lg text-center text-xl sm:text-2xl font-bold text-dark-ink focus:border-nutri-green focus:ring-2 focus:ring-nutri-green/50 outline-none" 
                                       type="text" maxlength="1" pattern="[0-9]*" inputmode="numeric" />
                                <input class="otp-input w-10 h-12 sm:w-12 sm:h-14 border border-smart-mist rounded-lg text-center text-xl sm:text-2xl font-bold text-dark-ink focus:border-nutri-green focus:ring-2 focus:ring-nutri-green/50 outline-none" 
                                       type="text" maxlength="1" pattern="[0-9]*" inputmode="numeric" />
                                <input class="otp-input w-10 h-12 sm:w-12 sm:h-14 border border-smart-mist rounded-lg text-center text-xl sm:text-2xl font-bold text-dark-ink focus:border-nutri-green focus:ring-2 focus:ring-nutri-green/50 outline-none" 
                                       type="text" maxlength="1" pattern="[0-9]*" inputmode="numeric" />
                                <input class="otp-input w-10 h-12 sm:w-12 sm:h-14 border border-smart-mist rounded-lg text-center text-xl sm:text-2xl font-bold text-dark-ink focus:border-nutri-green focus:ring-2 focus:ring-nutri-green/50 outline-none" 
                                       type="text" maxlength="1" pattern="[0-9]*" inputmode="numeric" />
                            </div>
                        </label>
                    </div>

                    <button type="submit" onclick="prepareSubmission()" class="w-full h-12 mt-6 rounded-lg bg-nutri-green text-white font-bold hover:opacity-90">
                        Verify Code
                    </button>

                    <div class="pt-6 w-full flex justify-between items-center text-sm">
                        <a th:href="@{/register/step1}" class="text-soft-grey hover:text-dark-ink transition-colors">
                            ‚Üê Change Email
                        </a>

                        <div class="flex gap-1 text-soft-grey">
                            <span>Didn't receive code?</span>
                            <a th:href="@{/register/resend}" class="font-bold text-nutri-green hover:underline cursor-pointer">
                                Resend
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const inputs = document.querySelectorAll('.otp-input');
                const hiddenInput = document.getElementById('hiddenOtpInput');

                function updateHiddenInput() {
                    let otpValue = '';
                    inputs.forEach(input => otpValue += input.value);
                    hiddenInput.value = otpValue;
                }

                inputs.forEach((input, index) => {
                    input.addEventListener('input', (e) => {
                        if (!/^\d*$/.test(e.target.value)) {
                            e.target.value = '';
                            return;
                        }
                        if (e.target.value.length === 1) {
                            if (index < inputs.length - 1)
                                inputs[index + 1].focus();
                        }
                        updateHiddenInput();
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && e.target.value === '') {
                            if (index > 0)
                                inputs[index - 1].focus();
                        }
                    });

                    input.addEventListener('paste', (e) => {
                        e.preventDefault();
                        const pasteData = e.clipboardData.getData('text').slice(0, 6);
                        if (!/^\d+$/.test(pasteData))
                            return;

                        pasteData.split('').forEach((char, i) => {
                            if (inputs[i])
                                inputs[i].value = char;
                        });

                        const lastFilledIndex = Math.min(pasteData.length, inputs.length) - 1;
                        if (lastFilledIndex >= 0)
                            inputs[lastFilledIndex].focus();
                        updateHiddenInput();
                    });
                });
            });

            function prepareSubmission() {
                const inputs = document.querySelectorAll('.otp-input');
                const hiddenInput = document.getElementById('hiddenOtpInput');
                let otpValue = '';
                inputs.forEach(input => otpValue += input.value);
                hiddenInput.value = otpValue;
            }
        </script>
    </body>
</html>