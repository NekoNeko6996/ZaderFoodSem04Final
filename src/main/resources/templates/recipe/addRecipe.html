<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Th√™m c√¥ng th·ª©c m·ªõi</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <style>
            .ingredient-row {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 10px;
                border: 1px solid #ddd;
            }
            .new-ingredient-form {
                display: none;
                background: #e9ecef;
                padding: 10px;
                margin-top: 10px;
                border-radius: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container mt-4">
            <h2>üç≥ ƒêƒÉng c√¥ng th·ª©c m√≥n ƒÉn m·ªõi</h2>

            <form th:action="@{/recipes/create}" th:object="${recipeForm}" method="post">

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">Th√¥ng tin m√≥n ƒÉn</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√™n m√≥n ƒÉn:</label>
                            <input type="text" th:field="*{name}" class="form-control" required placeholder="V√≠ d·ª•: Ph·ªü B√≤ Nam ƒê·ªãnh">
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ƒê·ªô kh√≥:</label>
                                <select th:field="*{difficulty}" class="form-select">
                                    <option value="EASY">D·ªÖ</option>
                                    <option value="MEDIUM">Trung b√¨nh</option>
                                    <option value="HARD">Kh√≥</option>
                                    <option value="CHEF_LEVEL">Si√™u kh√≥</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Kh·∫©u ph·∫ßn (ng∆∞·ªùi):</label>
                                <input type="number" th:field="*{servings}" class="form-control" min="1" required>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Chu·∫©n b·ªã (ph√∫t):</label>
                                <input type="number" th:field="*{prepTimeMin}" class="form-control" min="0" placeholder="VD: 15">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">N·∫•u (ph√∫t):</label>
                                <input type="number" th:field="*{cookTimeMin}" class="form-control" min="0" placeholder="VD: 30">
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label fw-bold">M√¥ t·∫£ ng·∫Øn:</label>
                            <textarea th:field="*{description}" class="form-control" rows="2" placeholder="Gi·ªõi thi·ªáu s∆° qua v·ªÅ m√≥n ƒÉn..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between">
                        <span>Danh s√°ch nguy√™n li·ªáu</span>
                        <button type="button" class="btn btn-sm btn-light" onclick="addIngredientRow()">+ Th√™m nguy√™n li·ªáu</button>
                    </div>
                    <div class="card-body" id="ingredients-container">
                        <datalist id="ingredientListData">
                            <option th:each="ing : ${availableIngredients}" 
                                    th:value="${ing.name}" 
                                    th:data-id="${ing.ingredientId}">
                            </option>
                        </datalist>

                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-info text-white">C√°c b∆∞·ªõc th·ª±c hi·ªán</div>
                    <div class="card-body" id="steps-container">
                        <button type="button" class="btn btn-secondary mb-3" onclick="addStepRow()">+ Th√™m b∆∞·ªõc</button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100">L∆∞u c√¥ng th·ª©c</button>
            </form>
        </div>

        <script th:inline="javascript">
            /* L·∫•y danh s√°ch category t·ª´ server ƒë·ªÉ render v√†o form th√™m m·ªõi */
            const categories = [[${categories}]];
            let ingredientIndex = 0;
            let stepIndex = 0;

            // H√†m render 1 d√≤ng nguy√™n li·ªáu
            function addIngredientRow() {
                const container = document.getElementById('ingredients-container');

                // T·∫°o chu·ªói HTML cho Category Options
                let categoryOptions = '<option value="">-- Ch·ªçn lo·∫°i --</option>';
                categories.forEach(cat => {
                    categoryOptions += `<option value="${cat.categoryId}">${cat.name}</option>`;
                });

                const html = `
                <div class="ingredient-row" id="ing-row-${ingredientIndex}">
                    <div class="d-flex justify-content-between mb-2">
                        <h5>Nguy√™n li·ªáu #${ingredientIndex + 1}</h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeRow('ing-row-${ingredientIndex}')">X√≥a</button>
                    </div>

                    <div class="row">
                        <div class="col-md-5">
                            <div class="existing-section">
                                <label>T√¨m nguy√™n li·ªáu:</label>
                                <input list="ingredientListData" 
                                       class="form-control" 
                                       placeholder="G√µ ƒë·ªÉ t√¨m..." 
                                       onchange="updateHiddenId(this, ${ingredientIndex})">
                                <input type="hidden" name="ingredients[${ingredientIndex}].existingIngredientId" id="ing-id-${ingredientIndex}">
                            </div>
                    
                            <div class="new-section mt-2" style="display:none;">
                                <input type="text" name="ingredients[${ingredientIndex}].newName" class="form-control" placeholder="T√™n nguy√™n li·ªáu m·ªõi (VD: L√° √©)">
                            </div>

                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" 
                                       name="ingredients[${ingredientIndex}].isNewIngredient" 
                                       value="true"
                                       id="check-new-${ingredientIndex}" 
                                       onchange="toggleNewIngredient(${ingredientIndex})">
                                <label class="form-check-label text-danger fw-bold" for="check-new-${ingredientIndex}">
                                    Kh√¥ng t√¨m th·∫•y? Th√™m nguy√™n li·ªáu m·ªõi
                                </label>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <label>S·ªë l∆∞·ª£ng:</label>
                            <input type="number" step="0.1" name="ingredients[${ingredientIndex}].quantity" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label>ƒê∆°n v·ªã:</label>
                            <input type="text" name="ingredients[${ingredientIndex}].unit" class="form-control" placeholder="gam, th√¨a..." required>
                        </div>
                         <div class="col-md-3">
                            <label>Ghi ch√∫:</label>
                            <input type="text" name="ingredients[${ingredientIndex}].note" class="form-control" placeholder="th√°i l√°t...">
                        </div>
                    </div>

                    <div class="new-ingredient-form row mt-3" id="new-form-${ingredientIndex}">
                        <div class="col-12"><small class="text-muted">Nh·∫≠p th√¥ng tin dinh d∆∞·ª°ng cho 100g nguy√™n li·ªáu m·ªõi n√†y:</small></div>
                        <div class="col-md-3">
                            <label>Danh m·ª•c:</label>
                            <select name="ingredients[${ingredientIndex}].categoryId" class="form-select">${categoryOptions}</select>
                        </div>
                        <div class="col-md-2">
                            <label>Calo (kcal):</label>
                            <input type="number" step="0.1" name="ingredients[${ingredientIndex}].caloriesPer100g" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label>Protein (g):</label>
                            <input type="number" step="0.1" name="ingredients[${ingredientIndex}].protein" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label>Fat (g):</label>
                            <input type="number" step="0.1" name="ingredients[${ingredientIndex}].fat" class="form-control">
                        </div>
                         <div class="col-md-2">
                            <label>Carb (g):</label>
                            <input type="number" step="0.1" name="ingredients[${ingredientIndex}].carbs" class="form-control">
                        </div>
                    </div>
                </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
                ingredientIndex++;
            }

            // H√†m chuy·ªÉn ƒë·ªïi gi·ªØa "Ch·ªçn c≈©" v√† "Nh·∫≠p m·ªõi"
            function toggleNewIngredient(index) {
                const row = document.getElementById(`ing-row-${index}`);
                const checkbox = document.getElementById(`check-new-${index}`);
                const existingSection = row.querySelector('.existing-section');
                const newSection = row.querySelector('.new-section');
                const newForm = document.getElementById(`new-form-${index}`);

                if (checkbox.checked) {
                    existingSection.style.display = 'none';
                    newSection.style.display = 'block';
                    newForm.style.display = 'flex';
                } else {
                    existingSection.style.display = 'block';
                    newSection.style.display = 'none';
                    newForm.style.display = 'none';
                }
            }

            // H√†m l·∫•y ID t·ª´ datalist khi user ch·ªçn t√™n
            function updateHiddenId(input, index) {
                const datalist = document.getElementById('ingredientListData');
                const hiddenInput = document.getElementById(`ing-id-${index}`);
                const options = datalist.options;

                // Reset tr∆∞·ªõc
                hiddenInput.value = '';

                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === input.value) {
                        hiddenInput.value = options[i].getAttribute('data-id');
                        break;
                    }
                }
            }

            // H√†m th√™m b∆∞·ªõc th·ª±c hi·ªán
            function addStepRow() {
                const container = document.getElementById('steps-container');

                // T·∫°o ID duy nh·∫•t cho d√≤ng n√†y ƒë·ªÉ c√≥ th·ªÉ x√≥a
                const currentRowId = `step-row-${stepIndex}`;

                const html = `
                <div class="input-group mb-2" id="${currentRowId}">
                    <span class="input-group-text">B∆∞·ªõc ${stepIndex + 1}</span>
                    <textarea name="steps" class="form-control" rows="2" placeholder="V√≠ d·ª•: ƒêun s√¥i n∆∞·ªõc, sau ƒë√≥ th·∫£ rau v√†o..." required></textarea>
                    <button type="button" class="btn btn-outline-danger" onclick="removeRow('${currentRowId}')">X√≥a</button>
                </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
                stepIndex++;
            }

            // ƒê·∫£m b·∫£o h√†m removeRow ƒë√£ c√≥ (n·∫øu ch∆∞a th√¨ th√™m v√†o)
            function removeRow(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.remove();
                }
            }

            // T·ª± ƒë·ªông th√™m 1 b∆∞·ªõc tr·ªëng khi load trang
            // (B·∫°n t√¨m ƒëo·∫°n window.onload c≈© v√† s·ª≠a l·∫°i nh∆∞ sau)
            window.onload = function () {
                addIngredientRow(); // Th√™m 1 d√≤ng nguy√™n li·ªáu
                addStepRow();       // Th√™m 1 b∆∞·ªõc th·ª±c hi·ªán
            };
        </script>
    </body>
</html>