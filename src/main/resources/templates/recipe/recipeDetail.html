<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
      lang="en">
    <head>
    <div th:replace="~{fragments/head :: common-head}"></div>
    <title th:text="${recipe.name + ' - Smart Meal Planner'}">Recipe Detail</title>
</head>
<body class="bg-background-light font-display text-dark-ink">
    <div class="relative flex min-h-screen w-full flex-col group/design-root">
        <div th:replace="~{fragments/navbar :: header_nav}"></div>

        <main class="flex flex-1 justify-center px-4 py-8 sm:px-8 sm:py-12">
            <div class="w-full max-w-5xl">
                <div class="bg-card-white rounded-xl shadow-soft overflow-hidden border border-border-color">

                    <div 
                        th:style="|background-image: url('${recipe.imageUrl != null ? recipe.imageUrl : 'https://via.placeholder.com/800x400'}');|">
                    </div>

                    <img th:src="${recipe.imageUrl}" 
                         class="w-full bg-center bg-no-repeat bg-cover flex flex-col justify-end min-h-[320px] md:min-h-[400px]"  
                         onerror="this.src='https://placehold.co/800x400?text=No_Image'" />

                    <div class="p-6 md:p-10">
                        <div class="flex flex-col gap-4 md:gap-6">
                            <div class="flex flex-wrap justify-between gap-4">
                                <div class="flex min-w-72 flex-col gap-2">
                                    <h1 class="text-dark-ink text-4xl font-black leading-tight tracking-[-0.033em]"
                                        th:text="${recipe.name}">Recipe Name</h1>

                                    <p class="text-soft-grey text-base font-normal leading-normal flex items-center gap-2">
                                        <span class="flex items-center gap-1"><span class="material-symbols-outlined !text-lg">schedule</span> <span th:text="${recipe.cookTimeMin} + ' min'"></span></span>
                                        <span>|</span>
                                        <span class="flex items-center gap-1"><span class="material-symbols-outlined !text-lg">group</span> <span th:text="${recipe.servings} + ' servings'"></span></span>
                                        <span th:if="${recipe.difficulty != null}" th:text="' | ' + ${recipe.difficulty}"></span>
                                    </p>

                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="h-6 w-6 rounded-full bg-smart-mist flex items-center justify-center text-soft-grey">
                                            <span class="material-symbols-outlined !text-sm">person</span>
                                        </div>
                                        <p class="text-sm text-soft-grey">
                                            Recipe by <span class="font-bold text-dark-ink" 
                                                            th:text="${recipe.user != null ? recipe.user.fullName : 'Zader Chef'}">Chef Name</span>
                                        </p>
                                    </div>

                                    <p class="text-dark-ink/80 text-sm mt-2" th:text="${recipe.description}"></p>

                                    <div class="mt-4 p-4 rounded-xl bg-background-light border border-border-color grid grid-cols-4 gap-2 text-center max-w-lg">
                                        <div class="flex flex-col">
                                            <span class="text-xs text-soft-grey font-bold uppercase">Calories</span>
                                            <span class="text-xl font-black text-dark-ink" th:text="${recipe.totalCalories}">0</span>
                                            <span class="text-[10px] text-soft-grey">kcal</span>
                                        </div>
                                        <div class="flex flex-col border-l border-border-color">
                                            <span class="text-xs text-soft-grey font-bold uppercase">Protein</span>
                                            <span class="text-xl font-black text-protein-blue" th:text="${recipe.protein != null ? recipe.protein : 0}">0</span>
                                            <span class="text-[10px] text-soft-grey">g</span>
                                        </div>
                                        <div class="flex flex-col border-l border-border-color">
                                            <span class="text-xs text-soft-grey font-bold uppercase">Carbs</span>
                                            <span class="text-xl font-black text-carbs-gold" th:text="${recipe.carbs != null ? recipe.carbs : 0}">0</span>
                                            <span class="text-[10px] text-soft-grey">g</span>
                                        </div>
                                        <div class="flex flex-col border-l border-border-color">
                                            <span class="text-xs text-soft-grey font-bold uppercase">Fat</span>
                                            <span class="text-xl font-black text-fat-red" th:text="${recipe.fat != null ? recipe.fat : 0}">0</span>
                                            <span class="text-[10px] text-soft-grey">g</span>
                                        </div>
                                    </div>

                                </div>

                                <div class="flex flex-wrap gap-3 items-start">
                                    <button onclick="openMealPlanModal()" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-chef-orange text-white text-base font-bold w-full sm:w-auto hover:bg-opacity-90 transition">
                                        Add to Meal Plan
                                    </button>
                                    <button
                                        th:data-id="${recipe.recipeId}"
                                        th:data-name="${recipe.name}"
                                        onclick="toggleHeart(event, this)"
                                        title="Add to Favorites"
                                        class="flex items-center justify-center w-12 h-12 rounded-lg border border-border-color text-soft-grey hover:text-chef-orange hover:border-chef-orange transition">
                                        <span class="material-symbols-outlined">favorite</span>
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-5 gap-8 md:gap-12 pt-6">
                                <div class="md:col-span-2">
                                    <h2 class="text-dark-ink text-[22px] font-bold leading-tight tracking-[-0.015em] pb-4">Ingredients</h2>
                                    <div class="flex flex-col gap-4">
                                        <label th:each="ri : ${recipe.recipeIngredients}" class="flex items-center gap-3 text-base text-dark-ink cursor-pointer group hover:bg-gray-50 p-2 rounded transition">
                                            <input class="h-5 w-5 rounded border-gray-300 text-chef-orange focus:ring-chef-orange/50" type="checkbox"/>
                                            <div class="flex flex-wrap gap-1">
                                                <span class="font-bold text-chef-orange" th:text="${ri.quantity}"></span>
                                                <span class="font-medium text-chef-orange" th:text="${ri.unit}"></span>
                                                <span class="text-dark-ink" th:text="${ri.ingredient != null ? ri.ingredient.name : 'Unknown'}"></span>
                                            </div>
                                        </label>
                                        <p th:if="${#lists.isEmpty(recipe.recipeIngredients)}" class="text-soft-grey italic">No ingredients listed.</p>
                                    </div>
                                </div>

                                <div class="md:col-span-3">
                                    <h2 class="text-dark-ink text-[22px] font-bold leading-tight tracking-[-0.015em] pb-4">Instructions</h2>
                                    <div class="prose prose-base text-dark-ink max-w-none">
                                        <ol class="list-decimal pl-5 space-y-4">
                                            <li th:each="step : ${recipe.recipeSteps}" class="pl-2">
                                                <span th:text="${step.instruction}"></span>
                                                <div th:if="${step.mediaUrl != null}" class="mt-2">
                                                    <img th:src="${step.mediaUrl}" class="rounded-lg h-40 object-cover" alt="Step image">
                                                </div>
                                            </li>
                                        </ol>
                                        <p th:if="${#lists.isEmpty(recipe.recipeSteps)}" class="text-soft-grey italic">No instructions available.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--review-->
                    <div class="border-t border-border-color p-6 md:p-10 mt-8">
                        <h2 class="text-dark-ink text-[22px] font-bold leading-tight tracking-[-0.015em] pb-4">
                            Reviews & Ratings 
                            <span class="text-base font-normal text-soft-grey" th:text="'(' + ${totalReviews} + ')'"></span>
                            <span class="text-chef-orange text-lg ml-2">★ <span th:text="${averageRating}"></span></span>
                        </h2>

                        <div sec:authorize="isAuthenticated()" class="mb-8 bg-background-light p-6 rounded-xl border border-border-color">
                            <h3 class="text-dark-ink font-bold mb-3">Leave a Review</h3>
                            <form th:action="@{/recipes/detail/{id}/review(id=${recipe.recipeId})}" method="post" th:object="${newReview}">

                                <div class="mb-4">
                                    <label class="block text-sm font-bold text-soft-grey mb-1">Rating</label>
                                    <select name="rating" class="w-full sm:w-1/4 h-10 px-3 rounded-lg border border-border-color focus:ring-chef-orange focus:border-chef-orange bg-white">
                                        <option value="5">★★★★★ (5/5) - Excellent</option>
                                        <option value="4">★★★★☆ (4/5) - Good</option>
                                        <option value="3">★★★☆☆ (3/5) - Average</option>
                                        <option value="2">★★☆☆☆ (2/5) - Poor</option>
                                        <option value="1">★☆☆☆☆ (1/5) - Terrible</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-bold text-soft-grey mb-1">Your Comment</label>
                                    <textarea name="comment" rows="3" required
                                              class="w-full p-3 rounded-lg border border-border-color focus:ring-chef-orange focus:border-chef-orange resize-none"
                                              placeholder="What did you think about this recipe?"></textarea>
                                </div>

                                <button type="submit" 
                                        class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-6 bg-chef-orange text-white text-sm font-bold hover:bg-opacity-90 transition">
                                    Post Review
                                </button>
                            </form>
                        </div>

                        <div sec:authorize="!isAuthenticated()" class="mb-8 p-4 bg-yellow-50 text-yellow-800 rounded-lg border border-yellow-200">
                            Please <a th:href="@{/login}" class="font-bold underline">login</a> to write a review.
                        </div>

                        <div th:with="currentUserId=${#authentication.principal != 'anonymousUser' ? #authentication.principal.userId : null}">

                            <div th:each="rv : ${reviews}" class="border-b border-gray-100 last:border-0 pb-6 last:pb-0 mb-6 group">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="h-10 w-10 rounded-full bg-smart-mist flex items-center justify-center text-soft-grey font-bold">
                                            <span class="material-symbols-outlined">person</span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-bold text-dark-ink">
                                                <span th:text="${rv.userId == currentUserId ? 'You' : 'User'}">User</span>
                                            </p> 
                                            <p class="text-xs text-soft-grey" th:text="${#temporals.format(rv.createdAt, 'dd-MM-yyyy HH:mm')}"></p>
                                        </div>
                                    </div>

                                    <div class="flex flex-col items-end gap-1">
                                        <div class="text-chef-orange font-bold text-sm">
                                            <span th:text="${rv.rating}"></span> ★
                                        </div>

                                        <div th:if="${rv.userId == currentUserId}" class="flex gap-2 flex-col justify-start opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button type="button" 
                                                    th:onclick="openEditReviewModal([[${rv.reviewId}]], [[${rv.rating}]], [[${rv.comment}]])"
                                                    class="font-bold text-blue-600 hover:text-blue-800 hover:underline flex justify-start">
                                                Edit
                                            </button>

                                            <form th:action="@{/recipes/detail/{rid}/review/{rvid}/delete(rid=${recipe.recipeId}, rvid=${rv.reviewId})}" 
                                                  method="post" 
                                                  th:id="'delete-review-' + ${rv.reviewId}">

                                                <button type="button" 
                                                        th:onclick="'confirmDeleteReview(' + ${rv.reviewId} + ')'"
                                                        class="font-bold text-red-500 hover:text-red-700 hover:underline">
                                                    Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <p class="text-dark-ink text-base leading-relaxed pl-[52px]" th:text="${rv.comment}"></p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </main>
        <div th:replace="~{fragments/toast :: toast-system}"></div>
    </div>

    <dialog id="mealPlanModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/40 w-full max-w-sm">
        <div class="p-5 border-b flex justify-between items-center bg-gray-50">
            <h3 class="text-lg font-bold text-dark-ink">Add to Meal Plan</h3>
            <button onclick="document.getElementById('mealPlanModal').close()" class="text-gray-400 hover:text-dark-ink">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="p-5 flex flex-col gap-5">

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Select Date</label>

                <div class="bg-white border border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-4">
                        <button id="calPrevBtn" onclick="changeCalendarMonth(-1)" class="p-1 hover:bg-gray-100 rounded-full text-gray-500">
                            <span class="material-symbols-outlined text-sm">chevron_left</span>
                        </button>
                        <span id="calMonthYear" class="text-sm font-bold text-dark-ink uppercase tracking-wide">DECEMBER 2025</span>
                        <button id="calNextBtn" onclick="changeCalendarMonth(1)" class="p-1 hover:bg-gray-100 rounded-full text-gray-500">
                            <span class="material-symbols-outlined text-sm">chevron_right</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        <span class="text-[10px] font-bold text-gray-400">S</span>
                        <span class="text-[10px] font-bold text-gray-400">M</span>
                        <span class="text-[10px] font-bold text-gray-400">T</span>
                        <span class="text-[10px] font-bold text-gray-400">W</span>
                        <span class="text-[10px] font-bold text-gray-400">T</span>
                        <span class="text-[10px] font-bold text-gray-400">F</span>
                        <span class="text-[10px] font-bold text-gray-400">S</span>
                    </div>

                    <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                        <div class="h-8 flex items-center justify-center text-xs text-gray-300">...</div>
                    </div>

                    <div class="flex justify-center gap-3 mt-3 pt-3 border-t border-gray-50 text-[10px] text-gray-400">
                        <div class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Good</div>
                        <div class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-yellow-500"></span> Fair</div>
                        <div class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Over</div>
                    </div>
                </div>

                <input type="hidden" id="selectedDateValue">
                <p id="selectedDateDisplay" class="text-xs text-nutri-green font-bold mt-2 text-right min-h-[16px]"></p>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Meal Time</label>
                <select id="mealTimeSelect" class="w-full rounded-lg border-gray-300 focus:ring-nutri-green text-sm">
                    <option value="BREAKFAST">Breakfast</option>
                    <option value="LUNCH">Lunch</option>
                    <option value="DINNER">Dinner</option>
                    <option value="SNACK">Snack</option>
                </select>
            </div>
        </div>

        <div class="p-5 border-t bg-gray-50 flex justify-end gap-3">
            <button onclick="document.getElementById('mealPlanModal').close()" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg text-sm">Cancel</button>
            <button onclick="confirmAddToMealPlan()" class="px-4 py-2 bg-nutri-green text-white font-bold hover:bg-green-600 rounded-lg shadow-sm text-sm">Add to Plan</button>
        </div>
    </dialog>

    <dialog id="editReviewModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/40 w-full max-w-md">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
            <h3 class="text-lg font-bold text-dark-ink">Edit Your Review</h3>
            <button onclick="document.getElementById('editReviewModal').close()" class="text-gray-400 hover:text-dark-ink">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <form id="editReviewForm" method="post" class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-bold text-soft-grey mb-1">Rating</label>
                <select id="editRating" name="rating" class="w-full px-3 py-2 rounded-lg border border-border-color focus:ring-chef-orange focus:border-chef-orange bg-white">
                    <option value="5">★★★★★ (5/5) - Excellent</option>
                    <option value="4">★★★★☆ (4/5) - Good</option>
                    <option value="3">★★★☆☆ (3/5) - Average</option>
                    <option value="2">★★☆☆☆ (2/5) - Poor</option>
                    <option value="1">★☆☆☆☆ (1/5) - Terrible</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-bold text-soft-grey mb-1">Comment</label>
                <textarea id="editComment" name="comment" rows="3" required
                          class="w-full p-3 rounded-lg border border-border-color focus:ring-chef-orange focus:border-chef-orange resize-none"></textarea>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('editReviewModal').close()" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-chef-orange text-white font-bold hover:bg-opacity-90 rounded-lg shadow-sm">Update Review</button>
            </div>
        </form>
    </dialog>

    <script>
        function openEditReviewModal(reviewId, currentRating, currentComment) {
            const modal = document.getElementById('editReviewModal');
            const form = document.getElementById('editReviewForm');
            const ratingInput = document.getElementById('editRating');
            const commentInput = document.getElementById('editComment');

            // 1. Cập nhật Action URL cho form
            // Lấy RecipeId từ URL hiện tại hoặc biến Thymeleaf nếu muốn
            // Cách đơn giản: RecipeId có sẵn trong URL trang hiện tại (/recipes/detail/{id})
            const currentUrl = window.location.pathname; // VD: /recipes/detail/10
            const recipeId = currentUrl.split('/').pop(); // Lấy số 10

            form.action = `/recipes/detail/${recipeId}/review/${reviewId}/edit`;

            // 2. Điền dữ liệu cũ vào form
            ratingInput.value = currentRating;
            commentInput.value = currentComment;

            // 3. Mở Modal
            modal.showModal();
        }
    </script>

    <script>
        function toggleHeart(event, btnElement) {
            event.preventDefault();
            event.stopPropagation();

            // 1. Lấy dữ liệu từ attribute
            const recipeId = btnElement.getAttribute('data-id');
            const recipeName = btnElement.getAttribute('data-name');
            const icon = btnElement.querySelector('span');

            // 2. GỌI TOAST LOADING
            const loadingToastId = ZaderToast.loading(`Adding "${recipeName}" to your favorites...`);

            setTimeout(() => {
                fetch('/recipes/api/favorite/' + recipeId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                        .then(response => {
                            if (response.status === 401) {
                                throw new Error("UNAUTHORIZED");
                            }
                            if (!response.ok) {
                                throw new Error("SERVER_ERROR");
                            }
                            return response.json();
                        })
                        .then(data => {
                            ZaderToast.remove(loadingToastId);

                            if (data.status === 'added' || data.status === 'exists') {
                                // Success logic
                                const msg = data.status === 'exists'
                                        ? `"${recipeName}" is already in your favorites.`
                                        : `"${recipeName}" has been added to favorites!`;

                                ZaderToast.success(msg);

                                // Update Icon UI
                                icon.classList.remove('text-gray-400');
                                icon.classList.add('text-red-500', 'fill-current');
                                icon.style.fontVariationSettings = "'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24";

                                // Animation
                                btnElement.classList.add('scale-110');
                                setTimeout(() => btnElement.classList.remove('scale-110'), 200);
                            }
                        })
                        .catch(error => {
                            ZaderToast.remove(loadingToastId);

                            if (error.message === "UNAUTHORIZED") {
                                ZaderToast.error("Please login to save recipes!");
                            } else {
                                ZaderToast.error("Failed to add recipe. Please try again.");
                            }
                            console.error('Error:', error);
                        });
            }, 500);
        }

        function confirmDeleteReview(reviewId) {
            Swal.fire({
                title: 'Delete this review?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444', // Màu đỏ (Tailwind red-500)
                cancelButtonColor: '#9CA3AF', // Màu xám
                confirmButtonText: 'Yes, delete it!',
                reverseButtons: true // Đảo vị trí nút cho thuận tay
            }).then((result) => {
                if (result.isConfirmed) {
                    // Nếu người dùng bấm Yes, tìm form theo ID và submit
                    const form = document.getElementById('delete-review-' + reviewId);
                    if (form) {
                        // (Optional) Hiện loading
                        if (typeof ZaderToast !== 'undefined')
                            ZaderToast.loading("Deleting...");
                        form.submit();
                    }
                }
            });
        }
    </script>

    <script>
        // --- VARIABLES ---
        let currentCalMonth = new Date().getMonth() + 1; // 1-12
        let currentCalYear = new Date().getFullYear();
        let selectedDate = null;

        // 1. Mở Modal và Load Lịch tháng hiện tại
        function openMealPlanModal() {
            const modal = document.getElementById('mealPlanModal');
            modal.showModal();

            // Reset
            selectedDate = null;
            document.getElementById('selectedDateValue').value = "";
            document.getElementById('selectedDateDisplay').innerText = "";

            // Load lịch
            loadMiniCalendar(currentCalMonth, currentCalYear);
        }

        // 2. Gọi API lấy dữ liệu lịch
        function loadMiniCalendar(month, year) {
            const grid = document.getElementById('calendarGrid');
            const header = document.getElementById('calMonthYear');

            // Loading UI
            grid.innerHTML = '<div class="col-span-7 py-4 text-center text-xs text-gray-400">Loading calendar...</div>';

            fetch(`/api/meal-plan/calendar?month=${month}&year=${year}`)
                    .then(res => {
                        if (res.status === 401)
                            throw new Error("UNAUTHORIZED");
                        return res.json();
                    })
                    .then(data => {
                        renderCalendarGrid(data);
                        header.innerText = `${data.monthName} ${data.year}`;
                        currentCalMonth = data.month;
                        currentCalYear = data.year;
                    })
                    .catch(err => {
                        if (err.message === "UNAUTHORIZED") {
                            document.getElementById('mealPlanModal').close();
                            ZaderToast.error("Please login first");
                        } else {
                            grid.innerHTML = '<div class="col-span-7 text-center text-red-400 text-xs">Failed to load</div>';
                        }
                    });
        }

        // 3. Render HTML cho Lịch (Đã Fix Tooltip tràn lề)
        function renderCalendarGrid(data) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // A. Render Offset (Khoảng trắng đầu tháng)
            // Cần tính tổng số ô đã render để biết vị trí cột của ngày hiện tại
            let cellCounter = 0;

            for (let i = 0; i < data.startOffset; i++) {
                grid.appendChild(document.createElement('div'));
                cellCounter++;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // B. Render Ngày
            data.days.forEach(day => {
                const dateStr = day.fullDate;
                const dayDate = new Date(dateStr);
                dayDate.setHours(0, 0, 0, 0);
                const isPast = dayDate < today;

                // Tính chỉ số cột (0: Chủ nhật, ..., 6: Thứ 7)
                const colIndex = cellCounter % 7;
                cellCounter++;

                // Container nút
                const btn = document.createElement('button');
                btn.className = `aspect-square relative flex items-center justify-center rounded-full text-xs font-medium transition-all group hover:bg-gray-100`;

                if (day.isToday) {
                    btn.classList.add('ring-2', 'ring-dark-ink', 'font-bold');
                }

                if (isPast) {
                    btn.classList.add('opacity-30', 'cursor-not-allowed');
                    btn.disabled = true;
                } else {
                    btn.onclick = () => selectDateInCalendar(btn, dateStr);
                }

                // 1. Số ngày
                btn.innerHTML = `<span class="z-10">${day.dayValue}</span>`;

                if (day.hasPlan) {
                    // 2. Dấu chấm màu
                    const dot = document.createElement('div');
                    dot.className = `absolute bottom-1 w-1 h-1 rounded-full`;
                    if (day.statusColor === 'GREEN')
                        dot.classList.add('bg-green-500');
                    else if (day.statusColor === 'YELLOW')
                        dot.classList.add('bg-yellow-500');
                    else if (day.statusColor === 'RED')
                        dot.classList.add('bg-red-500');
                    else
                        dot.classList.add('bg-gray-300');
                    btn.appendChild(dot);

                    // --- 3. TOOLTIP THÔNG MINH (SMART POSITIONING) ---

                    // Xác định class vị trí dựa trên cột
                    let tooltipPosClass = "left-1/2 -translate-x-1/2"; // Mặc định: Căn giữa
                    let arrowPosClass = "left-1/2 -translate-x-1/2";   // Mũi tên: Căn giữa

                    if (colIndex === 0 || colIndex === 1) {
                        // Sát lề trái -> Căn trái
                        tooltipPosClass = "left-0";
                        arrowPosClass = "left-3"; // Mũi tên lệch trái để trỏ vào nút
                    } else if (colIndex === 5 || colIndex === 6) {
                        // Sát lề phải -> Căn phải
                        tooltipPosClass = "right-0";
                        arrowPosClass = "right-3"; // Mũi tên lệch phải
                    }

                    const tooltipHtml = `
                    <div class="absolute bottom-full mb-2 ${tooltipPosClass} w-48 bg-white dark:bg-gray-800 p-3 rounded-lg shadow-xl border border-gray-100 dark:border-gray-700 hidden group-hover:block z-50 text-left pointer-events-none">
                        <div class="absolute top-full ${arrowPosClass} border-8 border-transparent border-t-white dark:border-t-gray-800"></div>
                        
                        <div class="border-b border-gray-100 pb-2 mb-2">
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Total Intake</p>
                            <div class="flex justify-between items-end">
                                <span class="text-sm font-black ${getDayColorClass(day.statusColor)}">${day.totalCalories}</span>
                                <span class="text-[10px] text-gray-400 mb-0.5">/ ${day.calorieGoal} kcal</span>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <div class="flex justify-between text-[10px]">
                                <span class="text-gray-500">Breakfast</span>
                                <span class="font-bold text-dark-ink">${day.breakfastCal}</span>
                            </div>
                            <div class="flex justify-between text-[10px]">
                                <span class="text-gray-500">Lunch</span>
                                <span class="font-bold text-dark-ink">${day.lunchCal}</span>
                            </div>
                            <div class="flex justify-between text-[10px]">
                                <span class="text-gray-500">Dinner</span>
                                <span class="font-bold text-dark-ink">${day.dinnerCal}</span>
                            </div>
                             <div class="flex justify-between text-[10px]">
                                <span class="text-gray-500">Snack</span>
                                <span class="font-bold text-dark-ink">${day.snackCal}</span>
                            </div>
                        </div>
                    </div>
                `;

                    btn.insertAdjacentHTML('beforeend', tooltipHtml);
                }

                grid.appendChild(btn);
            });
        }

        // Helper function để lấy màu text cho số tổng
        function getDayColorClass(status) {
            if (status === 'GREEN')
                return 'text-green-500';
            if (status === 'YELLOW')
                return 'text-yellow-500';
            if (status === 'RED')
                return 'text-red-500';
            return 'text-gray-400';
        }

        // 4. Xử lý chọn ngày
        function selectDateInCalendar(btnElement, dateStr) {
            // Xóa style selected cũ
            const allBtns = document.querySelectorAll('#calendarGrid button');
            allBtns.forEach(b => {
                b.classList.remove('bg-dark-ink', 'text-white', 'hover:bg-dark-ink');
                // Reset lại màu text nếu không phải là nút vừa bấm
                if (!b.disabled)
                    b.classList.add('text-dark-ink', 'hover:bg-gray-100');
            });

            // Add style selected mới
            btnElement.classList.remove('text-dark-ink', 'hover:bg-gray-100');
            btnElement.classList.add('bg-dark-ink', 'text-white', 'hover:bg-dark-ink');

            // Lưu giá trị
            selectedDate = dateStr;
            document.getElementById('selectedDateValue').value = dateStr;

            // Hiển thị text ngày chọn
            const displayDate = new Date(dateStr).toLocaleDateString('en-GB', {weekday: 'long', day: 'numeric', month: 'short'});
            document.getElementById('selectedDateDisplay').innerText = `Selected: ${displayDate}`;
        }

        // 5. Chuyển tháng
        function changeCalendarMonth(offset) {
            let newMonth = currentCalMonth + offset;
            let newYear = currentCalYear;

            if (newMonth > 12) {
                newMonth = 1;
                newYear++;
            } else if (newMonth < 1) {
                newMonth = 12;
                newYear--;
            }

            // Không cho phép lùi về tháng quá khứ sâu (Option)
            // if (newYear < new Date().getFullYear() || (newYear === new Date().getFullYear() && newMonth < new Date().getMonth() + 1)) return;

            loadMiniCalendar(newMonth, newYear);
        }

        // 6. Confirm Add (Logic cũ nhưng lấy date từ input hidden)
        function confirmAddToMealPlan() {
            const date = document.getElementById('selectedDateValue').value;
            const mealType = document.getElementById('mealTimeSelect').value;
            const recipeId = window.location.pathname.split('/').pop();

            if (!date) {
                ZaderToast.error("Please select a date on the calendar.");
                return;
            }

            const modal = document.getElementById('mealPlanModal');
            let loadingID = ZaderToast.loading("Adding to meal plan...");

            const payload = {
                recipeId: parseInt(recipeId),
                date: date,
                mealType: mealType
            };

            fetch('/api/meal-plan/add-item', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
                    .then(res => res.json())
                    .then(data => {
                        ZaderToast.remove(loadingID);
                        
                        if (data.status === 'success') {
                            modal.close();
                            ZaderToast.success(data.message);
                        } else if (data.status === 'duplicate') {
                            ZaderToast.warning(data.message);
                        } else {
                            ZaderToast.error("Failed: " + data.message);
                        }
                    })
                    .catch(err => {
                        console.log(err);
                        ZaderToast.error("An error occurred.");
                    });
        }
    </script>
</body>
</html>