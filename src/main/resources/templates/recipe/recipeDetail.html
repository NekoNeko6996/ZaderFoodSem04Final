<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
      lang="en">
    <head>
    <div th:replace="~{fragments/head :: common-head}"></div>
    <title th:text="${recipe.name + ' - Smart Meal Planner'}">Recipe Detail</title>
</head>
<body class="bg-background-light font-display text-dark-ink">
    <div class="relative flex min-h-screen w-full flex-col group/design-root">
        <div th:replace="~{fragments/navbar :: header_nav}"></div>

        <main class="flex flex-1 justify-center px-4 py-8 sm:px-8 sm:py-12">
            <div class="w-full max-w-5xl">
                <div class="bg-card-white rounded-xl shadow-soft overflow-hidden border border-border-color">

                    <div 
                        th:style="|background-image: url('${recipe.imageUrl != null ? recipe.imageUrl : 'https://via.placeholder.com/800x400'}');|">
                    </div>

                    <img th:src="${recipe.imageUrl}" 
                         class="w-full bg-center bg-no-repeat bg-cover flex flex-col justify-end min-h-[320px] md:min-h-[400px]"  
                         onerror="this.src='https://placehold.co/800x400?text=No_Image'" />

                    <div class="p-6 md:p-10">
                        <div class="flex flex-col gap-4 md:gap-6">
                            <div class="flex flex-wrap justify-between gap-4">
                                <div class="flex min-w-72 flex-col gap-2">
                                    <h1 class="text-dark-ink text-4xl font-black leading-tight tracking-[-0.033em]"
                                        th:text="${recipe.name}">Recipe Name</h1>

                                    <p class="text-soft-grey text-base font-normal leading-normal flex items-center gap-2">
                                        <span class="flex items-center gap-1"><span class="material-symbols-outlined !text-lg">schedule</span> <span th:text="${recipe.cookTimeMin} + ' min'"></span></span>
                                        <span>|</span>
                                        <span class="flex items-center gap-1"><span class="material-symbols-outlined !text-lg">group</span> <span th:text="${recipe.servings} + ' servings'"></span></span>
                                        <span th:if="${recipe.difficulty != null}" th:text="' | ' + ${recipe.difficulty}"></span>
                                    </p>

                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="h-6 w-6 rounded-full bg-smart-mist flex items-center justify-center text-soft-grey">
                                            <span class="material-symbols-outlined !text-sm">person</span>
                                        </div>
                                        <p class="text-sm text-soft-grey">
                                            Recipe by <span class="font-bold text-dark-ink" 
                                                            th:text="${recipe.user != null ? recipe.user.fullName : 'Zader Chef'}">Chef Name</span>
                                        </p>
                                    </div>

                                    <p class="text-dark-ink/80 text-sm mt-2" th:text="${recipe.description}"></p>

                                    <div class="mt-4 p-4 rounded-xl bg-background-light border border-border-color grid grid-cols-4 gap-2 text-center max-w-lg">
                                        <div class="flex flex-col">
                                            <span class="text-xs text-soft-grey font-bold uppercase">Calories</span>
                                            <span class="text-xl font-black text-dark-ink" th:text="${recipe.totalCalories}">0</span>
                                            <span class="text-[10px] text-soft-grey">kcal</span>
                                        </div>
                                        <div class="flex flex-col border-l border-border-color">
                                            <span class="text-xs text-soft-grey font-bold uppercase">Protein</span>
                                            <span class="text-xl font-black text-protein-blue" th:text="${recipe.protein != null ? recipe.protein : 0}">0</span>
                                            <span class="text-[10px] text-soft-grey">g</span>
                                        </div>
                                        <div class="flex flex-col border-l border-border-color">
                                            <span class="text-xs text-soft-grey font-bold uppercase">Carbs</span>
                                            <span class="text-xl font-black text-carbs-gold" th:text="${recipe.carbs != null ? recipe.carbs : 0}">0</span>
                                            <span class="text-[10px] text-soft-grey">g</span>
                                        </div>
                                        <div class="flex flex-col border-l border-border-color">
                                            <span class="text-xs text-soft-grey font-bold uppercase">Fat</span>
                                            <span class="text-xl font-black text-fat-red" th:text="${recipe.fat != null ? recipe.fat : 0}">0</span>
                                            <span class="text-[10px] text-soft-grey">g</span>
                                        </div>
                                    </div>

                                </div>

                                <div class="flex flex-wrap gap-3 items-start">
                                    <button class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-chef-orange text-white text-base font-bold w-full sm:w-auto hover:bg-opacity-90 transition">
                                        Add to Meal Plan
                                    </button>
                                    <button
                                        th:data-id="${recipe.recipeId}"
                                        th:data-name="${recipe.name}"
                                        onclick="toggleHeart(event, this)"
                                        title="Add to Favorites"
                                        class="flex items-center justify-center w-12 h-12 rounded-lg border border-border-color text-soft-grey hover:text-chef-orange hover:border-chef-orange transition">
                                        <span class="material-symbols-outlined">favorite</span>
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-5 gap-8 md:gap-12 pt-6">
                                <div class="md:col-span-2">
                                    <h2 class="text-dark-ink text-[22px] font-bold leading-tight tracking-[-0.015em] pb-4">Ingredients</h2>
                                    <div class="flex flex-col gap-4">
                                        <label th:each="ri : ${recipe.recipeIngredients}" class="flex items-center gap-3 text-base text-dark-ink cursor-pointer group hover:bg-gray-50 p-2 rounded transition">
                                            <input class="h-5 w-5 rounded border-gray-300 text-chef-orange focus:ring-chef-orange/50" type="checkbox"/>
                                            <div class="flex flex-wrap gap-1">
                                                <span class="font-bold text-chef-orange" th:text="${ri.quantity}"></span>
                                                <span class="font-medium text-chef-orange" th:text="${ri.unit}"></span>
                                                <span class="text-dark-ink" th:text="${ri.ingredient != null ? ri.ingredient.name : 'Unknown'}"></span>
                                            </div>
                                        </label>
                                        <p th:if="${#lists.isEmpty(recipe.recipeIngredients)}" class="text-soft-grey italic">No ingredients listed.</p>
                                    </div>
                                </div>

                                <div class="md:col-span-3">
                                    <h2 class="text-dark-ink text-[22px] font-bold leading-tight tracking-[-0.015em] pb-4">Instructions</h2>
                                    <div class="prose prose-base text-dark-ink max-w-none">
                                        <ol class="list-decimal pl-5 space-y-4">
                                            <li th:each="step : ${recipe.recipeSteps}" class="pl-2">
                                                <span th:text="${step.instruction}"></span>
                                                <div th:if="${step.mediaUrl != null}" class="mt-2">
                                                    <img th:src="${step.mediaUrl}" class="rounded-lg h-40 object-cover" alt="Step image">
                                                </div>
                                            </li>
                                        </ol>
                                        <p th:if="${#lists.isEmpty(recipe.recipeSteps)}" class="text-soft-grey italic">No instructions available.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--review-->
                    <div class="border-t border-border-color p-6 md:p-10 mt-8">
                        <h2 class="text-dark-ink text-[22px] font-bold leading-tight tracking-[-0.015em] pb-4">
                            Reviews & Ratings 
                            <span class="text-base font-normal text-soft-grey" th:text="'(' + ${totalReviews} + ')'"></span>
                            <span class="text-chef-orange text-lg ml-2">★ <span th:text="${averageRating}"></span></span>
                        </h2>

                        <div sec:authorize="isAuthenticated()" class="mb-8 bg-background-light p-6 rounded-xl border border-border-color">
                            <h3 class="text-dark-ink font-bold mb-3">Leave a Review</h3>
                            <form th:action="@{/recipes/detail/{id}/review(id=${recipe.recipeId})}" method="post" th:object="${newReview}">

                                <div class="mb-4">
                                    <label class="block text-sm font-bold text-soft-grey mb-1">Rating</label>
                                    <select name="rating" class="w-full sm:w-1/4 h-10 px-3 rounded-lg border border-border-color focus:ring-chef-orange focus:border-chef-orange bg-white">
                                        <option value="5">★★★★★ (5/5) - Excellent</option>
                                        <option value="4">★★★★☆ (4/5) - Good</option>
                                        <option value="3">★★★☆☆ (3/5) - Average</option>
                                        <option value="2">★★☆☆☆ (2/5) - Poor</option>
                                        <option value="1">★☆☆☆☆ (1/5) - Terrible</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-bold text-soft-grey mb-1">Your Comment</label>
                                    <textarea name="comment" rows="3" required
                                              class="w-full p-3 rounded-lg border border-border-color focus:ring-chef-orange focus:border-chef-orange resize-none"
                                              placeholder="What did you think about this recipe?"></textarea>
                                </div>

                                <button type="submit" 
                                        class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-6 bg-chef-orange text-white text-sm font-bold hover:bg-opacity-90 transition">
                                    Post Review
                                </button>
                            </form>
                        </div>

                        <div sec:authorize="!isAuthenticated()" class="mb-8 p-4 bg-yellow-50 text-yellow-800 rounded-lg border border-yellow-200">
                            Please <a th:href="@{/login}" class="font-bold underline">login</a> to write a review.
                        </div>

                        <div th:with="currentUserId=${#authentication.principal != 'anonymousUser' ? #authentication.principal.userId : null}">

                            <div th:each="rv : ${reviews}" class="border-b border-gray-100 last:border-0 pb-6 last:pb-0 mb-6 group">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="h-10 w-10 rounded-full bg-smart-mist flex items-center justify-center text-soft-grey font-bold">
                                            <span class="material-symbols-outlined">person</span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-bold text-dark-ink">
                                                <span th:text="${rv.userId == currentUserId ? 'You' : 'User'}">User</span>
                                            </p> 
                                            <p class="text-xs text-soft-grey" th:text="${#temporals.format(rv.createdAt, 'dd-MM-yyyy HH:mm')}"></p>
                                        </div>
                                    </div>

                                    <div class="flex flex-col items-end gap-1">
                                        <div class="text-chef-orange font-bold text-sm">
                                            <span th:text="${rv.rating}"></span> ★
                                        </div>

                                        <div th:if="${rv.userId == currentUserId}" class="flex gap-2 flex-col justify-start opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button type="button" 
                                                    th:onclick="openEditReviewModal([[${rv.reviewId}]], [[${rv.rating}]], [[${rv.comment}]])"
                                                    class="font-bold text-blue-600 hover:text-blue-800 hover:underline flex justify-start">
                                                Edit
                                            </button>

                                            <form th:action="@{/recipes/detail/{rid}/review/{rvid}/delete(rid=${recipe.recipeId}, rvid=${rv.reviewId})}" 
                                                  method="post" 
                                                  th:id="'delete-review-' + ${rv.reviewId}">

                                                <button type="button" 
                                                        th:onclick="'confirmDeleteReview(' + ${rv.reviewId} + ')'"
                                                        class="font-bold text-red-500 hover:text-red-700 hover:underline">
                                                    Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <p class="text-dark-ink text-base leading-relaxed pl-[52px]" th:text="${rv.comment}"></p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </main>
        <div th:replace="~{fragments/toast :: toast-system}"></div>
    </div>

    <dialog id="mealPlanModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/40 w-full max-w-md">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
            <h3 class="text-lg font-bold text-dark-ink">Add to Meal Plan</h3>
            <button onclick="document.getElementById('mealPlanModal').close()" class="text-gray-400 hover:text-dark-ink"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div class="p-6 flex flex-col gap-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Select Date</label>
                <select id="planDateSelect" class="w-full rounded-lg border-gray-300 focus:ring-nutri-green">
                    <option value="">Loading dates...</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Showing upcoming scheduled plans.</p>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Meal Time</label>
                <select id="mealTimeSelect" class="w-full rounded-lg border-gray-300 focus:ring-nutri-green">
                    <option value="BREAKFAST">Breakfast</option>
                    <option value="LUNCH">Lunch</option>
                    <option value="DINNER">Dinner</option>
                    <option value="SNACK">Snack</option>
                </select>
            </div>
        </div>
        <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
            <button onclick="document.getElementById('mealPlanModal').close()" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg">Cancel</button>
            <button onclick="confirmAddToMealPlan()" class="px-4 py-2 bg-nutri-green text-white font-bold hover:bg-green-600 rounded-lg shadow-sm">Save</button>
        </div>
    </dialog>

    <dialog id="editReviewModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/40 w-full max-w-md">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
            <h3 class="text-lg font-bold text-dark-ink">Edit Your Review</h3>
            <button onclick="document.getElementById('editReviewModal').close()" class="text-gray-400 hover:text-dark-ink">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <form id="editReviewForm" method="post" class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-bold text-soft-grey mb-1">Rating</label>
                <select id="editRating" name="rating" class="w-full px-3 py-2 rounded-lg border border-border-color focus:ring-chef-orange focus:border-chef-orange bg-white">
                    <option value="5">★★★★★ (5/5) - Excellent</option>
                    <option value="4">★★★★☆ (4/5) - Good</option>
                    <option value="3">★★★☆☆ (3/5) - Average</option>
                    <option value="2">★★☆☆☆ (2/5) - Poor</option>
                    <option value="1">★☆☆☆☆ (1/5) - Terrible</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-bold text-soft-grey mb-1">Comment</label>
                <textarea id="editComment" name="comment" rows="3" required
                          class="w-full p-3 rounded-lg border border-border-color focus:ring-chef-orange focus:border-chef-orange resize-none"></textarea>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('editReviewModal').close()" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded-lg">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-chef-orange text-white font-bold hover:bg-opacity-90 rounded-lg shadow-sm">Update Review</button>
            </div>
        </form>
    </dialog>

    <script>
        function openEditReviewModal(reviewId, currentRating, currentComment) {
            const modal = document.getElementById('editReviewModal');
            const form = document.getElementById('editReviewForm');
            const ratingInput = document.getElementById('editRating');
            const commentInput = document.getElementById('editComment');

            // 1. Cập nhật Action URL cho form
            // Lấy RecipeId từ URL hiện tại hoặc biến Thymeleaf nếu muốn
            // Cách đơn giản: RecipeId có sẵn trong URL trang hiện tại (/recipes/detail/{id})
            const currentUrl = window.location.pathname; // VD: /recipes/detail/10
            const recipeId = currentUrl.split('/').pop(); // Lấy số 10

            form.action = `/recipes/detail/${recipeId}/review/${reviewId}/edit`;

            // 2. Điền dữ liệu cũ vào form
            ratingInput.value = currentRating;
            commentInput.value = currentComment;

            // 3. Mở Modal
            modal.showModal();
        }
    </script>

    <script>
        function toggleHeart(event, btnElement) {
            event.preventDefault();
            event.stopPropagation();

            // 1. Lấy dữ liệu từ attribute
            const recipeId = btnElement.getAttribute('data-id');
            const recipeName = btnElement.getAttribute('data-name');
            const icon = btnElement.querySelector('span');

            // 2. GỌI TOAST LOADING
            const loadingToastId = ZaderToast.loading(`Adding "${recipeName}" to your favorites...`);

            setTimeout(() => {
                fetch('/recipes/api/favorite/' + recipeId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                        .then(response => {
                            if (response.status === 401) {
                                throw new Error("UNAUTHORIZED");
                            }
                            if (!response.ok) {
                                throw new Error("SERVER_ERROR");
                            }
                            return response.json();
                        })
                        .then(data => {
                            ZaderToast.remove(loadingToastId);

                            if (data.status === 'added' || data.status === 'exists') {
                                // Success logic
                                const msg = data.status === 'exists'
                                        ? `"${recipeName}" is already in your favorites.`
                                        : `"${recipeName}" has been added to favorites!`;

                                ZaderToast.success(msg);

                                // Update Icon UI
                                icon.classList.remove('text-gray-400');
                                icon.classList.add('text-red-500', 'fill-current');
                                icon.style.fontVariationSettings = "'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24";

                                // Animation
                                btnElement.classList.add('scale-110');
                                setTimeout(() => btnElement.classList.remove('scale-110'), 200);
                            }
                        })
                        .catch(error => {
                            ZaderToast.remove(loadingToastId);

                            if (error.message === "UNAUTHORIZED") {
                                ZaderToast.error("Please login to save recipes!");
                            } else {
                                ZaderToast.error("Failed to add recipe. Please try again.");
                            }
                            console.error('Error:', error);
                        });
            }, 500);
        }

        function confirmDeleteReview(reviewId) {
            Swal.fire({
                title: 'Delete this review?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444', // Màu đỏ (Tailwind red-500)
                cancelButtonColor: '#9CA3AF', // Màu xám
                confirmButtonText: 'Yes, delete it!',
                reverseButtons: true // Đảo vị trí nút cho thuận tay
            }).then((result) => {
                if (result.isConfirmed) {
                    // Nếu người dùng bấm Yes, tìm form theo ID và submit
                    const form = document.getElementById('delete-review-' + reviewId);
                    if (form) {
                        // (Optional) Hiện loading
                        if (typeof ZaderToast !== 'undefined')
                            ZaderToast.loading("Deleting...");
                        form.submit();
                    }
                }
            });
        }
    </script>
</body>
</html>