<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{fragments/head :: common-head}"><title>Day Detail</title></head>
    <body class="bg-smart-white dark:bg-background-dark font-display min-h-screen flex flex-col">

    <th:block th:replace="~{fragments/navbar :: header_nav}"></th:block>
    <th:block th:replace="~{fragments/toast :: toast-system}"></th:block>

    <style>
        @media print {
            /* Hide everything by default */
            body * {
                visibility: hidden;
            }

            /* Define the print area - We target the shopping list section */
            #shoppingListSection, #shoppingListSection * {
                visibility: visible;
            }

            /* Position the printable area to the top-left */
            #shoppingListSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }

            /* Hide elements inside the section that we don't want to print */
            .no-print, #paginationControls {
                display: none !important;
            }

            /* Ensure table looks good */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
            }
            th, td {
                border: 1px solid #ddd !important;
                padding: 8px !important;
            }

            /* Hide scrolling */
            .overflow-x-auto {
                overflow: visible !important;
            }
        }
    </style>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-[1400px]">

        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div class="flex items-center gap-4">
                <a href="/meal-plan/history" class="p-2 rounded-full bg-white hover:bg-gray-200 transition-colors shadow-sm border border-gray-200">
                    <span class="material-symbols-outlined">arrow_back</span>
                </a>
                <div>
                    <h1 class="text-2xl md:text-3xl font-black text-dark-ink dark:text-white" th:text="${dayDetail.dayName}">Date</h1>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-200"></span> Planned</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> Eaten</span>
                    </div>
                </div>
            </div>
        </div>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8"
                 th:with="target=${targetCalories ?: 2000},
                 eaten=${dayDetail.consumedCalories},
                 remaining=${target - dayDetail.consumedCalories}">

            <div class="bg-white dark:bg-[#1a0e0a] p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center relative">
                <h3 class="absolute top-6 left-6 text-xs font-bold text-gray-400 uppercase">Calories Remaining</h3>

                <div class="relative w-40 h-40 mt-4">
                    <canvas id="caloriesDoughnut"></canvas>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span class="text-3xl font-black" 
                              th:classappend="${remaining < 0} ? 'text-red-500' : 'text-dark-ink dark:text-white'"
                              th:text="${remaining}">0</span>
                        <span class="text-xs text-gray-400">kcal left</span>
                    </div>
                </div>

                <div class="flex justify-between w-full mt-6 px-4 text-sm border-t border-gray-100 dark:border-gray-700 pt-4">
                    <div class="text-center">
                        <span class="block text-gray-400 text-xs uppercase">Eaten</span>
                        <span class="font-bold text-orange-500 text-lg">[[${eaten}]]</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-gray-400 text-xs uppercase">Target</span>
                        <span class="font-bold text-dark-ink dark:text-white text-lg">[[${target}]]</span>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white dark:bg-[#1a0e0a] p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col justify-center gap-6">
                <div class="flex justify-between items-start border-b border-gray-100 dark:border-gray-700 pb-4">
                    <div>
                        <h3 class="text-lg font-bold text-dark-ink dark:text-white">Nutritional Breakdown</h3>
                        <p class="text-sm text-gray-400">Real-time tracking against your goals</p>
                    </div>
                    <span class="bg-gray-100 dark:bg-gray-800 text-gray-500 px-3 py-1 rounded-lg text-xs font-bold">
                        [[${dayDetail.eatenMeals}]] / [[${dayDetail.totalMeals}]] meals completed
                    </span>
                </div>

                <div class="space-y-6">
                    <div th:with="curr=${dayDetail.consumedProtein}, max=${targetProt ?: 1}">
                        <div class="flex justify-between text-sm mb-2 font-bold">
                            <span class="text-blue-600">Protein</span>
                            <span class="text-dark-ink dark:text-white">[[${curr}]] <span class="text-gray-400 font-normal">/ [[${max}]]g</span></span>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-4 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000 shadow-sm flex items-center justify-end pr-2 text-[10px] text-white font-bold"
                                 th:classappend="${curr > max} ? 'bg-red-500' : 'bg-blue-500'"
                                 th:style="'width: ' + ${T(java.lang.Math).min(curr * 100.0 / max, 100.0)} + '%'">
                                <span th:if="${curr > 0}" th:text="${#numbers.formatDecimal(curr * 100.0 / max, 0, 0)} + '%'"></span>
                            </div>
                        </div>
                        <p th:if="${curr > max}" class="text-xs text-red-500 mt-1 font-bold flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">warning</span> Limit exceeded!
                        </p>
                    </div>

                    <div th:with="curr=${dayDetail.consumedCarbs}, max=${targetCarb ?: 1}">
                        <div class="flex justify-between text-sm mb-2 font-bold">
                            <span class="text-green-600">Carbs</span>
                            <span class="text-dark-ink dark:text-white">[[${curr}]] <span class="text-gray-400 font-normal">/ [[${max}]]g</span></span>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-4 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000 shadow-sm flex items-center justify-end pr-2 text-[10px] text-white font-bold"
                                 th:classappend="${curr > max} ? 'bg-red-500' : 'bg-green-500'"
                                 th:style="'width: ' + ${T(java.lang.Math).min(curr * 100.0 / max, 100.0)} + '%'">
                                <span th:if="${curr > 0}" th:text="${#numbers.formatDecimal(curr * 100.0 / max, 0, 0)} + '%'"></span>
                            </div>
                        </div>
                        <p th:if="${curr > max}" class="text-xs text-red-500 mt-1 font-bold flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">warning</span> Limit exceeded!
                        </p>
                    </div>

                    <div th:with="curr=${dayDetail.consumedFat}, max=${targetFat ?: 1}">
                        <div class="flex justify-between text-sm mb-2 font-bold">
                            <span class="text-yellow-600">Fat</span>
                            <span class="text-dark-ink dark:text-white">[[${curr}]] <span class="text-gray-400 font-normal">/ [[${max}]]g</span></span>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-4 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000 shadow-sm flex items-center justify-end pr-2 text-[10px] text-white font-bold"
                                 th:classappend="${curr > max} ? 'bg-red-500' : 'bg-yellow-500'"
                                 th:style="'width: ' + ${T(java.lang.Math).min(curr * 100.0 / max, 100.0)} + '%'">
                                <span th:if="${curr > 0}" th:text="${#numbers.formatDecimal(curr * 100.0 / max, 0, 0)} + '%'"></span>
                            </div>
                        </div>
                        <p th:if="${curr > max}" class="text-xs text-red-500 mt-1 font-bold flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">warning</span> Limit exceeded!
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <div th:if="${not #lists.isEmpty(dayDetail.suggestions)}" class="mb-8 animate-fade-in-up">
            <div class="flex items-center gap-2 mb-4">
                <span class="material-symbols-outlined text-orange-500">lightbulb</span>
                <h3 class="font-bold text-dark-ink dark:text-white text-lg">Recommended for You</h3>
                <span class="text-xs text-gray-500 bg-gray-100 dark:bg-white/10 px-2 py-1 rounded">Based on your missing macros</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div th:each="sugg : ${dayDetail.suggestions}" class="bg-white dark:bg-[#1e1e1e] border border-orange-100 dark:border-orange-900/30 p-3 rounded-xl flex gap-3 shadow-sm hover:shadow-md transition-all relative group">
                    <img th:src="${sugg.imageUrl != null ? (sugg.imageUrl.startsWith('http') ? sugg.imageUrl : '/images/' + sugg.imageUrl) : 'https://placehold.co/100?text=Food'}" 
                         class="w-20 h-20 rounded-lg object-cover flex-shrink-0 bg-gray-100">

                    <div class="flex flex-col justify-between flex-grow">
                        <div>
                            <h4 class="font-bold text-sm text-dark-ink dark:text-white line-clamp-1" th:text="${sugg.recipeName}">Name</h4>
                            <p class="text-xs text-orange-600 font-bold">[[${sugg.calories}]] kcal</p>
                        </div>
                        <div class="flex gap-2 text-[10px] text-gray-400">
                            <span class="text-blue-500">P: [[${sugg.protein}]]</span>
                            <span class="text-green-500">C: [[${sugg.carbs}]]</span>
                            <span class="text-yellow-500">F: [[${sugg.fat}]]</span>
                        </div>
                    </div>

                    <button th:onclick="'quickAddRecipe(' + ${sugg.mealItemId} + ')'" 
                            class="absolute bottom-3 right-3 bg-orange-50 hover:bg-orange-500 text-orange-600 hover:text-white p-1.5 rounded-lg transition-colors shadow-sm"
                            title="Add to Snacks">
                        <span class="material-symbols-outlined text-lg">add</span>
                    </button>
                </div>
            </div>
        </div>


        <div class="flex items-center gap-2 mb-4 mt-3">
            <span class="material-symbols-outlined text-orange-500">menu_book_2</span>
            <h3 class="font-bold text-dark-ink dark:text-white text-lg">Today's menu</h3>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start mt-2">
            <div class="flex flex-col gap-4">
                <div class="sticky top-20 z-10 bg-gray-50/90 backdrop-blur-sm p-3 rounded-xl flex justify-between items-center border border-gray-200 shadow-sm">
                    <span class="font-black text-gray-500 uppercase tracking-wider text-sm pl-2">Breakfast</span>
                    <div class="flex gap-2">
                        <button onclick="skipMeal('Breakfast')" title="Skip all" class="p-2 bg-white hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-lg transition-colors shadow-sm border border-gray-200">
                            <span class="material-symbols-outlined text-lg">block</span>
                        </button>
                        <button onclick="openReplaceModal(null, 'Breakfast')" title="Add item" class="p-2 bg-white hover:bg-orange-50 text-gray-400 hover:text-orange-500 rounded-lg transition-colors shadow-sm border border-gray-200">
                            <span class="material-symbols-outlined text-lg">add</span>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col gap-4 min-h-[100px]">
                    <th:block th:each="meal : ${dayDetail.meals}">
                        <th:block th:if="${meal != null and (meal.type == 'Breakfast' or meal.type == 'BREAKFAST')}">
                            <div th:replace="~{fragments/meal-card-fragment::mealCardFragment(${meal})}"></div>
                        </th:block>
                    </th:block>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="sticky top-20 z-10 bg-gray-50/90 backdrop-blur-sm p-3 rounded-xl flex justify-between items-center border border-gray-200 shadow-sm">
                    <span class="font-black text-gray-500 uppercase tracking-wider text-sm pl-2">Lunch</span>
                    <div class="flex gap-2">
                        <button onclick="skipMeal('Lunch')" title="Skip all" class="p-2 bg-white hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-lg transition-colors shadow-sm border border-gray-200">
                            <span class="material-symbols-outlined text-lg">block</span>
                        </button>
                        <button onclick="openReplaceModal(null, 'Lunch')" title="Add item" class="p-2 bg-white hover:bg-orange-50 text-gray-400 hover:text-orange-500 rounded-lg transition-colors shadow-sm border border-gray-200">
                            <span class="material-symbols-outlined text-lg">add</span>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col gap-4 min-h-[100px]">
                    <th:block th:each="meal : ${dayDetail.meals}">
                        <th:block th:if="${meal != null and (meal.type == 'Lunch' or meal.type == 'LUNCH')}">
                            <div th:replace="~{fragments/meal-card-fragment::mealCardFragment(${meal})}"></div>
                        </th:block>
                    </th:block>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="sticky top-20 z-10 bg-gray-50/90 backdrop-blur-sm p-3 rounded-xl flex justify-between items-center border border-gray-200 shadow-sm">
                    <span class="font-black text-gray-500 uppercase tracking-wider text-sm pl-2">Dinner</span>
                    <div class="flex gap-2">
                        <button onclick="skipMeal('Dinner')" title="Skip all" class="p-2 bg-white hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-lg transition-colors shadow-sm border border-gray-200">
                            <span class="material-symbols-outlined text-lg">block</span>
                        </button>
                        <button onclick="openReplaceModal(null, 'Dinner')" title="Add item" class="p-2 bg-white hover:bg-orange-50 text-gray-400 hover:text-orange-500 rounded-lg transition-colors shadow-sm border border-gray-200">
                            <span class="material-symbols-outlined text-lg">add</span>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col gap-4 min-h-[100px]">
                    <th:block th:each="meal : ${dayDetail.meals}">
                        <th:block th:if="${meal != null and (meal.type == 'Dinner' or meal.type == 'DINNER')}">
                            <div th:replace="~{fragments/meal-card-fragment::mealCardFragment(${meal})}"></div>
                        </th:block>
                    </th:block>
                </div>
            </div>

        </div>
        <section id="shoppingListSection" class="bg-white dark:bg-[#1a0e0a] rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden mt-8 mb-12">
            <div class="p-6 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-black text-dark-ink dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-600">checklist</span>
                        Daily Shopping List
                    </h2>
                    <p class="text-sm text-gray-500">Ingredients needed for today's meals.</p>
                </div>
                <span class="text-xs font-bold bg-green-100 text-green-700 px-3 py-1 rounded-full">
                    [[${dayDetail.dailyIngredients != null ? #lists.size(dayDetail.dailyIngredients) : 0}]] Items
                </span>
            </div>

            <div class="flex gap-2 p-4">
                <button onclick="exportToExcel()" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 text-green-600 rounded-lg hover:bg-green-50 text-xs font-bold transition-all shadow-sm">
                    <span class="material-symbols-outlined text-sm">download</span>View with Excel
                </button>
                <button onclick="sendEmail()" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 text-blue-600 rounded-lg hover:bg-blue-50 text-xs font-bold transition-all shadow-sm">
                    <span class="material-symbols-outlined text-sm">mail</span>Send me Email
                </button>
                <button onclick="printShoppingList()" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 text-xs font-bold transition-all shadow-sm">
                    <span class="material-symbols-outlined text-sm">print</span> Print
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse" id="shoppingTable">
                    <thead>
                        <tr class="text-xs font-bold text-gray-400 border-b border-gray-100 dark:border-gray-800">
                            <th class="p-4 uppercase tracking-wider">Ingredient</th>
                            <th class="p-4 uppercase tracking-wider w-32">Quantity</th>
                            <th class="p-4 uppercase tracking-wider w-32 text-center">Check</th>
                        </tr>
                    </thead>
                    <tbody id="shoppingListBody" class="text-sm divide-y divide-gray-100 dark:divide-gray-800">
                        <tr th:each="item : ${dayDetail.dailyIngredients}" class="shopping-item group hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                            <td class="p-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center overflow-hidden flex-shrink-0">
                                        <img th:src="${item.imageUrl == null ? 'https://placehold.co/100x100?text=No+Img' : (#strings.startsWith(item.imageUrl, 'http') ? item.imageUrl : '/images/' + item.imageUrl)}" 
                                             onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=Err'" 
                                             class="w-full h-full object-cover">
                                    </div>
                                    <div>
                                        <p class="font-bold text-dark-ink dark:text-white" th:text="${item.name}">Name</p>
                                        <p class="text-xs text-gray-400" th:text="${item.category}">Category</p>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 font-medium text-gray-600 dark:text-gray-300" th:text="${item.quantity}">Qty</td>
                            <td class="p-4 text-center">
                                <input type="checkbox" class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500 cursor-pointer">
                            </td>
                        </tr>

                        <tr th:if="${#lists.isEmpty(dayDetail.dailyIngredients)}">
                            <td colspan="3" class="p-8 text-center text-gray-400">
                                <div class="flex flex-col items-center">
                                    <span class="material-symbols-outlined text-4xl mb-2 text-gray-300">shopping_basket</span>
                                    <p>No ingredients found. Are recipes assigned to these meals?</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="paginationControls" class="p-4 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50/30"
                 th:if="${not #lists.isEmpty(dayDetail.dailyIngredients)}">
                <span class="text-xs text-gray-500">Showing <span id="pageInfo">1-5</span> of [[${#lists.size(dayDetail.dailyIngredients)}]] items</span>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" id="btnPrev" class="px-3 py-1 rounded bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-100 disabled:opacity-50">Prev</button>
                    <button onclick="changePage(1)" id="btnNext" class="px-3 py-1 rounded bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-100 disabled:opacity-50">Next</button>
                </div>
            </div>
        </section>
    </main>

    <div id="replaceModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-100">

                <div class="bg-white px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-black text-dark-ink flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">edit_note</span> Update Meal
                    </h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 rounded-full p-1 transition-colors"><span class="material-symbols-outlined">close</span></button>
                </div>

                <div class="flex border-b border-gray-100">
                    <button onclick="switchTab('AI')" id="tabAI" class="flex-1 py-3 text-sm font-bold text-primary border-b-2 border-primary bg-primary/5 transition-all">
                        ‚ú® AI Analysis
                    </button>
                    <button onclick="switchTab('MANUAL')" id="tabManual" class="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-dark-ink transition-all">
                        üìù Manual Input
                    </button>
                </div>

                <div class="px-6 py-6 flex flex-col gap-5">

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Dish Name <span class="text-red-500">*</span></label>
                        <input type="text" id="replaceName" placeholder="e.g. Grilled Salmon" class="w-full rounded-lg border-gray-200 bg-gray-50 text-sm focus:border-primary focus:ring-primary">
                    </div>

                    <div id="sectionAI" class="flex flex-col gap-4">
                        <div class="w-full">
                            <label for="replaceImage" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer bg-gray-50 hover:bg-orange-50 hover:border-orange-300 transition-all group overflow-hidden relative">
                                <img id="previewImg" class="absolute inset-0 w-full h-full object-cover hidden opacity-90">
                                <div id="uploadPlaceholder" class="flex flex-col items-center justify-center pt-5 pb-6 group-hover:scale-105 transition-transform">
                                    <span class="material-symbols-outlined text-3xl text-gray-400 group-hover:text-orange-500 mb-2">add_a_photo</span>
                                    <p class="mb-1 text-xs text-gray-500">Upload photo for AI scan</p>
                                </div>
                                <input id="replaceImage" type="file" class="hidden" accept="image/*" onchange="previewFile()">
                            </label>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description (Optional)</label>
                            <textarea id="replaceDesc" rows="2" placeholder="Describe ingredients for better accuracy..." class="w-full rounded-lg border-gray-200 bg-gray-50 text-sm resize-none focus:border-primary focus:ring-primary"></textarea>
                        </div>

                        <div id="aiResultArea" class="hidden p-3 bg-orange-50 rounded-xl border border-orange-100 animate-fade-in-up">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-bold text-orange-600">‚ú® AI Estimated:</p>
                                <button onclick="useAiResult()" class="text-[10px] bg-white border border-orange-200 px-2 py-1 rounded hover:bg-orange-100 text-orange-600 font-bold">Apply Data</button>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-center text-xs">
                                <div><span class="block font-black" id="aiCalVal">0</span> kcal</div>
                                <div><span class="block font-bold text-blue-600" id="aiProtVal">0</span>g Pro</div>
                                <div><span class="block font-bold text-green-600" id="aiCarbVal">0</span>g Carb</div>
                                <div><span class="block font-bold text-yellow-600" id="aiFatVal">0</span>g Fat</div>
                            </div>
                        </div>
                    </div>

                    <div id="sectionManual" class="hidden flex flex-col gap-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Calories (kcal)</label>
                                <input type="number" id="manualCal" class="w-full rounded-lg border-gray-200 bg-white text-sm font-bold text-dark-ink focus:border-primary focus:ring-primary">
                            </div>
                            <div></div> 
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-blue-500 uppercase mb-1">Protein (g)</label>
                                <input type="number" id="manualProt" class="w-full rounded-lg border-blue-100 bg-blue-50/30 text-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-green-500 uppercase mb-1">Carbs (g)</label>
                                <input type="number" id="manualCarb" class="w-full rounded-lg border-green-100 bg-green-50/30 text-sm focus:border-green-500 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-yellow-600 uppercase mb-1">Fat (g)</label>
                                <input type="number" id="manualFat" class="w-full rounded-lg border-yellow-100 bg-yellow-50/30 text-sm focus:border-yellow-500 focus:ring-yellow-500">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-2 border-t border-gray-100">
                    <button type="button" id="btnConfirm" onclick="confirmReplace()" class="hidden w-full inline-flex justify-center items-center gap-2 rounded-lg bg-green-600 px-4 py-2 text-sm font-bold text-white hover:bg-green-500 shadow-lg shadow-green-200 sm:w-auto transition-all">
                        <span class="material-symbols-outlined text-lg">check</span> Save Meal
                    </button>

                    <button type="button" id="btnAnalyze" onclick="analyzeFood()" class="w-full inline-flex justify-center items-center gap-2 rounded-lg bg-orange-500 px-4 py-2 text-sm font-bold text-white hover:bg-orange-600 shadow-lg shadow-orange-200 sm:w-auto transition-all">
                        <span class="material-symbols-outlined text-lg">auto_awesome</span> Analyze
                    </button>

                    <button onclick="closeModal()" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mealSelectModal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/40 backdrop-blur-[2px] transition-opacity" onclick="closeMealSelectModal()"></div>

        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-xl transition-all sm:w-full sm:max-w-sm border border-gray-100 p-5">

                <h3 class="text-lg font-bold text-dark-ink mb-2">Add to Meal Plan</h3>
                <p class="text-sm text-gray-500 mb-4">Select which meal to add this item to:</p>

                <div class="mb-5">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Meal Type</label>
                    <select id="targetMealType" class="w-full rounded-lg border-gray-200 bg-gray-50 text-sm focus:border-orange-500 focus:ring-orange-500 py-2.5">
                    </select>
                </div>

                <div class="flex gap-2">
                    <button onclick="closeMealSelectModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold hover:bg-gray-200 transition-all">Cancel</button>
                    <button onclick="confirmAddToPlan()" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-bold hover:bg-orange-600 shadow-md shadow-orange-200 transition-all">
                        Add Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{fragments/footer :: footer_section}"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
                        // 1. CONFIG & GLOBALS
                        const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                        const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                        // Check authentication safely using Thymeleaf
                        const USER_ID = /*[[${#authentication != null and #authentication.principal != 'anonymousUser' ? #authentication.principal.userId : 0}]]*/ 0;

                        // Fallback for ZaderToast if not loaded
                        window.ZaderToast = window.ZaderToast || {
                            success: (msg) => alert("‚úÖ " + msg),
                            error: (msg) => alert("‚ùå " + msg),
                            info: (msg) => alert("‚ÑπÔ∏è " + msg),
                            loading: (msg) => {
                                console.log(msg);
                                return 'temp-id';
                            },
                            remove: (id) => {
                            }
                        };

                        // --- UTILITIES ---

                        async function fetchPost(url, bodyData = {}) {
                            const formData = new FormData();
                            for (const k in bodyData)
                                formData.append(k, bodyData[k]);

                            const headers = {};
                            if (CSRF_TOKEN && CSRF_HEADER)
                                headers[CSRF_HEADER] = CSRF_TOKEN;

                            return await fetch(url, {
                                method: 'POST',
                                headers: headers,
                                body: formData
                            });
                        }

                        function getPageParams() {
                            const urlParts = window.location.pathname.split('/');
                            const dateStr = urlParts[urlParts.length - 1];
                            return {dateStr, userId: USER_ID};
                        }

                        // --- INITIALIZATION ---
                        document.addEventListener('DOMContentLoaded', function () {
                            initChart();
                            initPagination();
                        });

                        function initChart() {
                            const eaten = /*[[${dayDetail.consumedCalories}]]*/ 0;
                            const target = /*[[${targetCalories ?: 2000}]]*/ 2000;
                            const remaining = Math.max(0, target - eaten);

                            const ctx = document.getElementById('caloriesDoughnut');
                            if (ctx) {
                                new Chart(ctx.getContext('2d'), {
                                    type: 'doughnut',
                                    data: {
                                        labels: ['Eaten', 'Remaining'],
                                        datasets: [{
                                                data: [eaten, remaining],
                                                backgroundColor: [
                                                    eaten > target ? '#EF4444' : '#F97316',
                                                    '#F3F4F6'
                                                ],
                                                borderWidth: 0,
                                                hoverOffset: 4
                                            }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        cutout: '85%',
                                        plugins: {legend: {display: false}, tooltip: {enabled: false}}
                                    }
                                });
                            }
                        }

                        // --- 1. MEAL ACTIONS (Mark, Undo, Skip, Snack) ---

                        async function markAsEaten(id) {
                            if (!id || id === 'null') {
                                ZaderToast.error("Error: Item ID missing");
                                return;
                            }
                            try {
                                const res = await fetchPost(`/api/meal-plan/item/${id}/status`, {status: 'EATEN'});
                                if (res.ok) {
                                    ZaderToast.success("Marked as Eaten!");
                                    setTimeout(() => location.reload(), 500);
                                } else {
                                    ZaderToast.error("Failed to update status.");
                                }
                            } catch (e) {
                                console.error(e);
                            }
                        }

                        async function undoStatus(id) {
                            try {
                                const res = await fetchPost(`/api/meal-plan/item/${id}/status`, {status: 'PENDING'});
                                if (res.ok) {
                                    ZaderToast.success("Status reverted.");
                                    setTimeout(() => location.reload(), 500);
                                }
                            } catch (e) {
                                console.error(e);
                            }
                        }

                        function skipMeal(type) {
                            Swal.fire({
                                title: `Skip ${type}?`,
                                text: "Mark items as skipped?",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#d33',
                                confirmButtonText: 'Yes, Skip'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // C·∫ßn tri·ªÉn khai API backend cho vi·ªác skip theo MealType
                                    ZaderToast.success("Meal skipped (Simulated).");
                                    setTimeout(() => location.reload(), 1000);
                                }
                            });
                        }

                        // --- 2. SHOPPING ACTIONS (Export, Email) ---

                        function exportToExcel() {
                            const {dateStr} = getPageParams();
                            if (USER_ID === 0) {
                                ZaderToast.error("Please login.");
                                return;
                            }
                            // Redirect to download
                            window.location.href = `/api/meal-plan/shopping-list/export-excel?dateStr=${dateStr}`;
                        }

                        async function sendEmail() {
                            const {dateStr} = getPageParams();
                            if (USER_ID === 0) {
                                ZaderToast.error("Please login.");
                                return;
                            }

                            const loadingId = ZaderToast.loading("Sending email...");
                            try {
                                const res = await fetchPost('/api/meal-plan/shopping-list/send-email', {dateStr: dateStr});

                                if (res.ok) {
                                    ZaderToast.remove(loadingId);
                                    ZaderToast.success("Email sent! Check your inbox.");
                                } else {
                                    const data = await res.json();
                                    ZaderToast.remove(loadingId);
                                    ZaderToast.error(data.error || "Failed to send email.");
                                }
                            } catch (e) {
                                ZaderToast.remove(loadingId);
                                ZaderToast.error("Connection error.");
                            }
                        }

                        // --- 3. MODAL LOGIC (ƒê√É S·ª¨A L·ªñI) ---
                        let currentItemId = null;
                        let currentMealType = null;
                        let currentMode = 'AI'; // Bi·∫øn theo d√µi ch·∫ø ƒë·ªô hi·ªán t·∫°i

                        // [QUAN TR·ªåNG] H√†m switchTab b·ªã thi·∫øu tr∆∞·ªõc ƒë√≥
                        function switchTab(mode) {
                            currentMode = mode;

                            // L·∫•y c√°c ph·∫ßn t·ª≠ an to√†n (ki·ªÉm tra t·ªìn t·∫°i tr∆∞·ªõc khi thao t√°c)
                            const tabAI = document.getElementById('tabAI');
                            const tabManual = document.getElementById('tabManual');
                            const secAI = document.getElementById('sectionAI');
                            const secManual = document.getElementById('sectionManual');
                            const btnAnalyze = document.getElementById('btnAnalyze');
                            const btnConfirm = document.getElementById('btnConfirm');

                            if (!tabAI || !secAI)
                                return; // Ch·∫∑n l·ªói n·∫øu HTML ch∆∞a update

                            if (mode === 'AI') {
                                // UI: Active Tab AI
                                tabAI.className = "flex-1 py-3 text-sm font-bold text-primary border-b-2 border-primary bg-primary/5 transition-all";
                                tabManual.className = "flex-1 py-3 text-sm font-bold text-gray-500 hover:text-dark-ink transition-all";

                                secAI.classList.remove('hidden');
                                secManual.classList.add('hidden');

                                if (btnAnalyze)
                                    btnAnalyze.classList.remove('hidden');
                                if (btnConfirm)
                                    btnConfirm.classList.add('hidden');
                            } else {
                                // UI: Active Tab Manual
                                tabManual.className = "flex-1 py-3 text-sm font-bold text-primary border-b-2 border-primary bg-primary/5 transition-all";
                                tabAI.className = "flex-1 py-3 text-sm font-bold text-gray-500 hover:text-dark-ink transition-all";

                                secManual.classList.remove('hidden');
                                secAI.classList.add('hidden');

                                if (btnAnalyze)
                                    btnAnalyze.classList.add('hidden');
                                if (btnConfirm)
                                    btnConfirm.classList.remove('hidden');
                            }
                        }

                        function deleteMealItem(id) {
                            Swal.fire({
                                title: 'Delete this meal?',
                                text: "You won't be able to revert this!",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#d33',
                                confirmButtonText: 'Yes, delete it!'
                            }).then(async (result) => {
                                if (result.isConfirmed) {
                                    try {
                                        const res = await fetch(`/api/meal-plan/item/${id}`, {
                                            method: 'DELETE',
                                            headers: {
                                                [CSRF_HEADER]: CSRF_TOKEN // Quan tr·ªçng: Ph·∫£i c√≥ CSRF cho Delete
                                            }
                                        });

                                        if (res.ok) {
                                            ZaderToast.success("Meal deleted.");
                                            setTimeout(() => location.reload(), 500);
                                        } else {
                                            ZaderToast.error("Failed to delete.");
                                        }
                                    } catch (e) {
                                        ZaderToast.error("Connection error.");
                                    }
                                }
                            });
                        }

                        async function openReplaceModal(itemId, mealType) {
                            currentMealType = mealType;
                            currentItemId = itemId;

                            resetModal(); // Reset form tr·∫Øng tr∆∞·ªõc

                            // N·∫øu c√≥ itemId -> L√† ch·∫ø ƒë·ªô EDIT -> G·ªçi API l·∫•y d·ªØ li·ªáu c≈© fill v√†o form
                            if (itemId) {
                                try {
                                    // Hi·ªÉn th·ªã loading nh·∫π ho·∫∑c disable form l√∫c ƒëang fetch...
                                    const res = await fetch(`/api/meal-plan/item/${itemId}`);
                                    if (res.ok) {
                                        const data = await res.json();

                                        // Fill v√†o Tab Manual
                                        document.getElementById('replaceName').value = data.customDishName || "";
                                        document.getElementById('manualCal').value = data.calories || 0;
                                        document.getElementById('manualProt').value = data.protein || 0;
                                        document.getElementById('manualCarb').value = data.carbs || 0;
                                        document.getElementById('manualFat').value = data.fat || 0;

                                        // Chuy·ªÉn ngay sang tab Manual ƒë·ªÉ user s·ª≠a
                                        switchTab('MANUAL');

                                        // ƒê·ªïi n√∫t Confirm th√†nh "Update"
                                        document.getElementById('btnConfirm').innerHTML = '<span class="material-symbols-outlined text-lg">save</span> Update Meal';
                                    }
                                } catch (e) {
                                    console.error("Error fetching item details", e);
                                }
                            } else {
                                // N·∫øu kh√¥ng c√≥ ID -> ADD NEW -> M·∫∑c ƒë·ªãnh tab AI
                                switchTab('AI');
                                document.getElementById('btnConfirm').innerHTML = '<span class="material-symbols-outlined text-lg">add</span> Add Meal';
                            }

                            const modal = document.getElementById('replaceModal');
                            if (modal)
                                modal.classList.remove('hidden');
                        }

                        function closeModal() {
                            const modal = document.getElementById('replaceModal');
                            if (modal)
                                modal.classList.add('hidden');
                        }

                        function resetModal() {
                            // Helper set value an to√†n
                            const setVal = (id, val) => {
                                const el = document.getElementById(id);
                                if (el)
                                    el.value = val;
                            };
                            // Helper ·∫©n hi·ªán class an to√†n
                            const addClass = (id, cls) => {
                                const el = document.getElementById(id);
                                if (el)
                                    el.classList.add(cls);
                            };
                            const removeClass = (id, cls) => {
                                const el = document.getElementById(id);
                                if (el)
                                    el.classList.remove(cls);
                            };

                            setVal('replaceImage', "");
                            addClass('previewImg', 'hidden');
                            removeClass('uploadPlaceholder', 'opacity-0');
                            setVal('replaceName', "");
                            setVal('replaceDesc', "");

                            // Reset v√πng k·∫øt qu·∫£
                            addClass('aiResultArea', 'hidden');
                            addClass('btnConfirm', 'hidden');

                            // Reset n√∫t Analyze
                            const btnAnalyze = document.getElementById('btnAnalyze');
                            if (btnAnalyze) {
                                btnAnalyze.classList.remove('hidden');
                                btnAnalyze.disabled = false;
                                // Kh√¥i ph·ª•c n·ªôi dung g·ªëc c·ªßa n√∫t (Icon + Text)
                                btnAnalyze.innerHTML = '<span class="material-symbols-outlined text-lg">auto_awesome</span> Analyze';
                            }
                        }

                        async function analyzeFood() {
                            const fileInput = document.getElementById('replaceImage');
                            const nameInput = document.getElementById('replaceName');
                            const descInput = document.getElementById('replaceDesc');

                            // L·∫•y d·ªØ li·ªáu input
                            const file = fileInput ? fileInput.files[0] : null;
                            const name = nameInput ? nameInput.value : "";
                            const desc = descInput ? descInput.value : "";

                            // K·∫øt h·ª£p Name v√† Desc ƒë·ªÉ AI hi·ªÉu r√µ h∆°n (V√≠ d·ª•: "Ph·ªü b√≤. Kh√¥ng h√†nh")
                            const fullDescription = name + (desc ? ". " + desc : "");
                            if (!file || !name) {
                                if (window.ZaderToast)
                                    ZaderToast.error("Please upload a photo or enter a dish name.");
                                return;
                            }


                            const btnAnalyze = document.getElementById('btnAnalyze');
                            if (!btnAnalyze)
                                return;

                            // UI Loading
                            btnAnalyze.disabled = true;
                            // Gi·ªØ l·∫°i icon SVG spinner
                            btnAnalyze.innerHTML = `Analyzing... <svg class="animate-spin ml-1 h-4 w-4 inline-block text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

                            try {
                                // G·ªçi API th·∫≠t b·∫±ng h√†m fetchPost c√≥ s·∫µn
                                // L∆∞u √Ω: fetchPost c·ªßa b·∫°n ƒë√£ h·ªó tr·ª£ t·ª± ƒë·ªông t·∫°o FormData khi truy·ªÅn object
                                const res = await fetchPost('/api/meal-plan/analyze-food', {
                                    image: file, // File object
                                    description: fullDescription // String
                                });

                                if (res.ok) {
                                    const result = await res.json();

                                    // --- X·ª¨ L√ù K·∫æT QU·∫¢ T·ª™ AI ---

                                    // Helper parse s·ªë an to√†n (V√¨ AI c√≥ th·ªÉ tr·∫£ v·ªÅ "30g" ho·∫∑c 30)
                                    const parseVal = (v) => {
                                        if (typeof v === 'number')
                                            return v;
                                        return v ? parseFloat(v.toString().replace(/[^\d.]/g, '')) || 0 : 0;
                                    };

                                    const finalData = {
                                        cal: result.calories || 0,
                                        pro: parseVal(result.protein),
                                        carb: parseVal(result.carbs),
                                        fat: parseVal(result.fat)
                                    };

                                    // 1. ƒêi·ªÅn v√†o v√πng hi·ªÉn th·ªã AI Result
                                    const elCal = document.getElementById('aiCalVal');
                                    const elPro = document.getElementById('aiProtVal');
                                    const elCarb = document.getElementById('aiCarbVal');
                                    const elFat = document.getElementById('aiFatVal');

                                    if (elCal)
                                        elCal.innerText = finalData.cal;
                                    if (elPro)
                                        elPro.innerText = finalData.pro;
                                    if (elCarb)
                                        elCarb.innerText = finalData.carb;
                                    if (elFat)
                                        elFat.innerText = finalData.fat;

                                    // 2. ƒêi·ªÅn t√™n m√≥n n·∫øu input ƒëang tr·ªëng v√† AI tr·∫£ v·ªÅ t√™n
                                    if (result.dishName && nameInput && !nameInput.value) {
                                        nameInput.value = result.dishName;
                                    }

                                    // 3. Hi·ªÉn th·ªã UI
                                    const elResultArea = document.getElementById('aiResultArea');
                                    const btnConfirm = document.getElementById('btnConfirm');

                                    if (elResultArea)
                                        elResultArea.classList.remove('hidden');
                                    btnAnalyze.classList.add('hidden');
                                    if (btnConfirm)
                                        btnConfirm.classList.remove('hidden');

                                    // 4. T·ª± ƒë·ªông ƒëi·ªÅn sang Tab Manual (ƒë·ªÉ khi b·∫•m Save s·∫Ω l·∫•y s·ªë li·ªáu n√†y)
                                    if (typeof fillManualForm === 'function') {
                                        fillManualForm(finalData);
                                    }

                                    ZaderToast.success("AI Analysis Complete!");

                                } else {
                                    const errData = await res.json();
                                    ZaderToast.error(errData.error || "AI could not analyze this image.");

                                    // Reset n√∫t
                                    btnAnalyze.disabled = false;
                                    btnAnalyze.innerHTML = '<span class="material-symbols-outlined text-lg">auto_awesome</span> Analyze';
                                }

                            } catch (e) {
                                console.error(e);
                                ZaderToast.error("Connection error. Is AI server running?");

                                // Reset n√∫t
                                btnAnalyze.disabled = false;
                                btnAnalyze.innerHTML = '<span class="material-symbols-outlined text-lg">auto_awesome</span> Analyze';
                            }
                        }

                        async function confirmReplace() {
                            // A. L·∫•y d·ªØ li·ªáu t·ª´ Form (AI ƒë√£ ƒëi·ªÅn v√†o c√°c √¥ n√†y r·ªìi)
                            const name = document.getElementById('replaceName').value;
                            // L·∫•y t·ª´ tab Manual (v√¨ tab AI c≈©ng fill d·ªØ li·ªáu v√†o ƒë√¢y)
                            const cal = document.getElementById('manualCal').value || 0;
                            const pro = document.getElementById('manualProt').value || 0;
                            const carb = document.getElementById('manualCarb').value || 0;
                            const fat = document.getElementById('manualFat').value || 0;

                            // L·∫•y file ·∫£nh (n·∫øu c√≥)
                            const file = document.getElementById('replaceImage').files[0];

                            if (!name) {
                                if (window.ZaderToast)
                                    ZaderToast.error("Dish name is required");
                                return;
                            }

                            // B. Chu·∫©n b·ªã FormData ƒë·ªÉ g·ª≠i
                            const formData = {
                                dishName: name,
                                calories: cal,
                                protein: pro,
                                carbs: carb,
                                fat: fat
                            };
                            if (file) {
                                formData.image = file;
                            }

                            // UI Loading
                            const btnConfirm = document.getElementById('btnConfirm');
                            const originalText = btnConfirm.innerHTML;
                            btnConfirm.disabled = true;
                            btnConfirm.innerHTML = 'Saving...';

                            try {
                                let res;
                                // C. G·ªçi API
                                if (currentItemId) {
                                    // Update
                                    res = await fetchPost(`/api/meal-plan/item/${currentItemId}/update`, formData);
                                } else {
                                    // Add New (N·∫øu logic modal h·ªó tr·ª£ th√™m m·ªõi)
                                    const {dateStr} = getPageParams();
                                    formData.dateStr = dateStr;
                                    formData.type = currentMealType;
                                    res = await fetchPost('/api/meal-plan/item/add', formData);
                                }

                                if (res.ok) {
                                    if (window.ZaderToast)
                                        ZaderToast.success("Saved successfully!");
                                    setTimeout(() => location.reload(), 1000);
                                } else {
                                    const data = await res.json();
                                    if (window.ZaderToast)
                                        ZaderToast.error(data.error || "Failed to save.");
                                    btnConfirm.disabled = false;
                                    btnConfirm.innerHTML = originalText;
                                }
                            } catch (e) {
                                console.error(e);
                                if (window.ZaderToast)
                                    ZaderToast.error("Connection error.");
                                btnConfirm.disabled = false;
                                btnConfirm.innerHTML = originalText;
                            }
                        }

                        function useAiResult() {
                            const aiCal = document.getElementById('aiCalVal')?.innerText || 0;
                            const aiPro = document.getElementById('aiProtVal')?.innerText || 0;
                            const aiCarb = document.getElementById('aiCarbVal')?.innerText || 0;
                            const aiFat = document.getElementById('aiFatVal')?.innerText || 0;

                            document.getElementById('manualCal').value = aiCal;
                            document.getElementById('manualProt').value = aiPro;
                            document.getElementById('manualCarb').value = aiCarb;
                            document.getElementById('manualFat').value = aiFat;

                            // Chuy·ªÉn sang tab manual ƒë·ªÉ user review
                            switchTab('MANUAL');
                        }

                        // --- H√ÄM X·ª¨ L√ù PREVIEW ·∫¢NH ---
                        function previewFile() {
                            const preview = document.getElementById('previewImg');
                            const fileInput = document.getElementById('replaceImage');
                            const placeholder = document.getElementById('uploadPlaceholder');

                            // Ki·ªÉm tra xem input c√≥ file kh√¥ng
                            if (fileInput && fileInput.files && fileInput.files[0]) {
                                const file = fileInput.files[0];
                                const reader = new FileReader();

                                reader.onloadend = function () {
                                    if (preview) {
                                        preview.src = reader.result;
                                        preview.classList.remove('hidden');
                                    }
                                    if (placeholder) {
                                        placeholder.classList.add('opacity-0'); // ·∫®n icon upload ƒëi
                                    }
                                }
                                reader.readAsDataURL(file);
                            } else {
                                // N·∫øu user h·ªßy ch·ªçn file th√¨ reset l·∫°i
                                if (preview) {
                                    preview.src = "";
                                    preview.classList.add('hidden');
                                }
                                if (placeholder) {
                                    placeholder.classList.remove('opacity-0');
                                }
                            }
                        }

                        // --- 4. PAGINATION ---
                        let currentPage = 1;
                        const itemsPerPage = 200;

                        function initPagination() {
                            const rows = document.querySelectorAll('.shopping-item');
                            const totalItems = rows.length;
                            if (totalItems === 0)
                                return;

                            const totalPages = Math.ceil(totalItems / itemsPerPage);

                            function updateDisplay() {
                                const start = (currentPage - 1) * itemsPerPage;
                                const end = start + itemsPerPage;

                                rows.forEach((row, index) => {
                                    if (index >= start && index < end)
                                        row.style.display = '';
                                    else
                                        row.style.display = 'none';
                                });

                                const pageInfo = document.getElementById('pageInfo');
                                if (pageInfo)
                                    pageInfo.innerText = `${start + 1}-${Math.min(end, totalItems)}`;

                                const btnPrev = document.getElementById('btnPrev');
                                const btnNext = document.getElementById('btnNext');

                                if (btnPrev)
                                    btnPrev.disabled = (currentPage === 1);
                                if (btnNext)
                                    btnNext.disabled = (currentPage === totalPages);
                            }

                            window.changePage = function (step) {
                                currentPage += step;
                                if (currentPage < 1)
                                    currentPage = 1;
                                if (currentPage > totalPages)
                                    currentPage = totalPages;
                                updateDisplay();
                            };

                            updateDisplay();
                        }


                        function printShoppingList() {
                            window.print();
                        }

                        // --- LOGIC QUICK ADD & SELECT MEAL ---
                        let pendingAddRecipeId = null; // Bi·∫øn t·∫°m l∆∞u ID m√≥n ƒëang ch·ªçn

                        function quickAddRecipe(recipeId) {
                            if (!recipeId)
                                return;
                            pendingAddRecipeId = recipeId; // L∆∞u l·∫°i ID ƒë·ªÉ d√πng sau

                            const {dateStr} = getPageParams();
                            const selectBox = document.getElementById('targetMealType');
                            selectBox.innerHTML = ''; // X√≥a options c≈©

                            // 1. X√°c ƒë·ªãnh th·ªùi gian ƒë·ªÉ l·ªçc b·ªØa ƒÉn
                            const now = new Date();
                            const currentHour = now.getHours();

                            // Parse ng√†y t·ª´ URL (YYYY-MM-DD)
                            const parts = dateStr.split('-');
                            // L∆∞u √Ω: Month trong JS b·∫Øt ƒë·∫ßu t·ª´ 0
                            const planDate = new Date(parts[0], parts[1] - 1, parts[2]);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0); // Reset gi·ªù v·ªÅ 0h s√°ng ƒë·ªÉ so s√°nh ng√†y

                            // Danh s√°ch c√°c b·ªØa ƒÉn chu·∫©n
                            // label: T√™n hi·ªÉn th·ªã, value: Gi√° tr·ªã g·ª≠i API, limitHour: Gi·ªù gi·ªõi h·∫°n (n·∫øu l√† h√¥m nay)
                            const mealOptions = [
                                {label: 'Breakfast', value: 'BREAKFAST', limitHour: 10},
                                {label: 'Lunch', value: 'LUNCH', limitHour: 14},
                                {label: 'Dinner', value: 'DINNER', limitHour: 21},
                            ];

                            // 2. Logic l·ªçc
                            let availableOptions = [];

                            // Ki·ªÉm tra: C√≥ ph·∫£i l√† "H√¥m nay" kh√¥ng?
                            const isToday = planDate.getTime() === today.getTime();

                            if (isToday) {
                                // N·∫øu l√† h√¥m nay, ch·ªâ hi·ªán b·ªØa ch∆∞a qua
                                availableOptions = mealOptions.filter(opt => currentHour < opt.limitHour);
                            } else {
                                // N·∫øu l√† ng√†y kh√°c (Qu√° kh·ª© ho·∫∑c T∆∞∆°ng lai), hi·ªán t·∫•t c·∫£
                                availableOptions = mealOptions;
                            }

                            // 3. Render ra Select Box
                            if (availableOptions.length === 0) {
                                // Tr∆∞·ªùng h·ª£p hi·∫øm: Qu√° 24h (kh√¥ng x·∫£y ra th·ª±c t·∫ø v√¨ Snack limit 24)
                                availableOptions.push({label: 'Snack (Late Night)', value: 'SNACK'});
                            }

                            availableOptions.forEach(opt => {
                                const option = document.createElement('option');
                                option.value = opt.value;
                                option.text = opt.label;
                                selectBox.appendChild(option);
                            });

                            // 4. M·ªü Modal
                            document.getElementById('mealSelectModal').classList.remove('hidden');
                        }

                        function closeMealSelectModal() {
                            document.getElementById('mealSelectModal').classList.add('hidden');
                            pendingAddRecipeId = null;
                        }

                        // H√†m x√°c nh·∫≠n th√™m (Khi b·∫•m n√∫t Add trong Modal)
                        async function confirmAddToPlan() {
                            const {dateStr} = getPageParams();
                            const mealType = document.getElementById('targetMealType').value;

                            if (!pendingAddRecipeId || !mealType)
                                return;

                            // ƒê√≥ng modal ngay cho m∆∞·ª£t
                            closeMealSelectModal();
                            const loadingId = ZaderToast.loading(`Adding to ${mealType}...`);

                            try {
                                // G·ªçi API th√™m m√≥n (ƒë√£ c√≥ ·ªü b∆∞·ªõc tr∆∞·ªõc)
                                const res = await fetchPost('/api/meal-plan/add-recipe-to-plan', {
                                    dateStr: dateStr,
                                    recipeId: pendingAddRecipeId,
                                    mealType: mealType // Gi√° tr·ªã t·ª´ select box
                                });

                                if (res.ok) {
                                    ZaderToast.remove(loadingId);
                                    ZaderToast.success("Added successfully!");
                                    setTimeout(() => location.reload(), 800);
                                } else {
                                    const data = await res.json();
                                    ZaderToast.remove(loadingId);
                                    ZaderToast.error(data.error || "Failed to add.");
                                }
                            } catch (e) {
                                console.error(e);
                                ZaderToast.remove(loadingId);
                                ZaderToast.error("Connection error.");
                            }
                        }
    </script>
</body>
</html>