<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{fragments/head :: common-head}">
        <title>Customize Meal Plan</title>
    </head>
    <body class="flex flex-col min-h-screen bg-smart-white dark:bg-background-dark font-display">

    <th:block th:replace="~{fragments/toast :: toast-system}"></th:block>
    <th:block th:replace="~{fragments/navbar :: header_nav}"></th:block>

    <main class="flex-grow px-4 sm:px-6 lg:px-10 py-8">
        <div class="mx-auto flex max-w-[1400px] flex-col gap-8">

            <div class="flex flex-wrap justify-between gap-3 p-4">
                <div class="flex min-w-72 flex-col gap-2">
                    <h1 class="text-dark-ink dark:text-white text-4xl font-black">Your Weekly Plan</h1>
                    <p class="text-gray-500">Review and customize your AI-generated schedule.</p>
                </div>
                <div class="flex gap-3">
                    <a href="/meal-plan/generate" class="flex items-center justify-center gap-2 h-10 px-6 rounded-lg bg-gray-200 text-dark-ink text-sm font-bold">
                        <span class="material-symbols-outlined text-base">refresh</span> Regenerate
                    </a>
                    <button onclick="savePlan()" class="flex items-center justify-center h-10 px-8 rounded-lg bg-chef-orange text-white text-sm font-bold shadow-lg shadow-chef-orange/20">
                        Save to Account
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                <div class="lg:col-span-3 flex flex-col gap-6 sticky top-24">
                    <div class="bg-white dark:bg-background-dark rounded-xl shadow-soft p-6 flex flex-col gap-4">
                        <div class="flex justify-between items-center cursor-pointer" onclick="toggleSearchPanel()">
                            <h2 class="text-dark-ink dark:text-white text-lg font-bold">Find Recipes</h2>
                            <span id="toggleIcon" class="material-symbols-outlined text-gray-400 transform transition-transform">expand_less</span>
                        </div>

                        <div id="searchPanelContent" class="flex flex-col gap-4 transition-all duration-300">
                            <div class="flex flex-col gap-3">
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                                        <span class="material-symbols-outlined text-lg">search</span>
                                    </span>
                                    <input type="text" id="miniSearchKeyword" placeholder="Search by name..." 
                                           class="w-full pl-10 pr-3 py-2 rounded-lg border border-gray-200 text-sm focus:ring-primary focus:border-primary"
                                           onkeyup="onSearchInput()"> </div>

                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500 font-bold">Max Cal:</span>
                                    <input type="range" id="miniSearchCal" min="100" max="2000" step="50" value="2000"
                                           class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"
                                           oninput="onCalorieChange(this.value)">
                                    <span id="calLabel" class="text-xs font-bold text-primary w-12 text-right">2000</span>
                                </div>
                            </div>

                            <div id="miniSearchResults" class="flex flex-col gap-3 overflow-y-auto pr-1 max-h-[300px] min-h-[100px] border-t border-gray-100 pt-3">
                                <p class="text-xs text-gray-400 text-center mt-4">Type to search...</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-background-dark rounded-xl shadow-soft p-6 flex flex-col gap-4 max-h-[600px]">
                        <div class="flex justify-between items-center">
                            <h2 class="text-dark-ink dark:text-white text-lg font-bold">My Collections</h2>
                        </div>

                        <select id="collectionSelect" onchange="loadCollectionRecipes(this.value)"
                                class="w-full rounded-lg border-gray-200 text-sm focus:ring-primary focus:border-primary">
                            <option value="">-- Select a Collection --</option>
                            <th:block th:each="col : ${myCollections}">
                                <option th:value="${col.collectionId}" th:text="${col.name}">My Favorites</option>
                            </th:block>
                        </select>

                        <div id="draggableSource" class="flex flex-col gap-3 overflow-y-auto pr-1 flex-1 min-h-[300px]">
                            <p class="text-sm text-gray-400 text-center mt-10">Select a collection to view recipes.</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-9 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    <th:block th:each="day, dayStat : ${weeklyPlan.days}">
                        <div class="weekly-day-card flex flex-col gap-4 p-4 rounded-xl shadow-sm border transition-all relative"
                             th:classappend="${day.hasConflict} ? 'bg-orange-50 border-orange-300 dark:bg-orange-900/10 dark:border-orange-700' : 'bg-white border-gray-100 dark:bg-[#1e1e1e] dark:border-gray-700'"
                             th:data-has-conflict="${day.hasConflict}"
                             th:data-current-source="${day.currentSource}"
                             th:data-alt-meals="${day.altMealsJsonString}" th:data-alt-cal="${day.altTotalCalories}">

                            <div class="flex justify-between items-center border-b pb-2" 
                                 th:classappend="${day.hasConflict} ? 'border-orange-200' : 'border-gray-100'">

                                <div class="flex flex-col">
                                    <a th:href="@{/meal-plan/day/{date}(date=${day.dateString})}" 
                                       class="font-bold text-lg text-primary hover:underline hover:text-orange-700 transition-colors" 
                                       th:text="${day.dayName}">
                                        Monday
                                    </a>
                                    <span th:if="${day.currentSource == 'SAVED_DB'}" class="text-[10px] font-bold text-white bg-green-600 px-2 py-0.5 rounded w-fit">SAVED IN DB</span>
                                    <span th:if="${day.currentSource.startsWith('NEW')}" class="text-[10px] font-bold text-white bg-blue-500 px-2 py-0.5 rounded w-fit">NEW DRAFT</span>
                                </div>

                                <div class="flex items-center gap-1 bg-white/50 px-2 py-1 rounded text-xs font-bold text-dark-ink total-cal-badge"
                                     th:id="'cal-day-' + ${dayStat.index}"
                                     th:data-value="${day.totalCalories}">
                                    <span th:text="${day.totalCalories}">1500</span> / <span th:text="${targetCalories}">2000</span> kcal
                                </div>
                            </div>

                            <div class="flex flex-col gap-4" th:id="'meals-container-' + ${dayStat.index}">

                                <div class="meal-section flex flex-col gap-2">
                                    <div class="flex justify-between items-center"> <span class="text-xs font-bold text-gray-400 uppercase">Breakfast</span>
                                        <button onclick="addMealSlot(this, 'Breakfast')" type="button" 
                                                class="text-[10px] bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-dark-ink transition-colors font-bold">
                                            + Add Item
                                        </button>
                                    </div>
                                    <div class="meal-list-container flex flex-col gap-2" data-type="Breakfast">
                                        <th:block th:each="meal : ${day.meals}" th:if="${meal != null and (meal.type == 'Breakfast' or meal.type == 'BREAKFAST')}">
                                            <div th:replace="~{fragments/meal-slot-fragment::mealSlotFragment(${meal}, ${dayStat.index})}"></div>
                                        </th:block>
                                    </div>
                                </div>
                                <div class="meal-section flex flex-col gap-2 border-t border-dashed border-gray-100 pt-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs font-bold text-gray-400 uppercase">Lunch</span>
                                        <button onclick="addMealSlot(this, 'Lunch')" type="button" 
                                                class="text-[10px] bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-dark-ink transition-colors font-bold">
                                            + Add Item
                                        </button>
                                    </div>
                                    <div class="meal-list-container flex flex-col gap-2" data-type="Lunch">
                                        <th:block th:each="meal : ${day.meals}" th:if="${meal != null and (meal.type == 'Lunch' or meal.type == 'LUNCH')}">
                                            <div th:replace="~{fragments/meal-slot-fragment::mealSlotFragment(${meal}, ${dayStat.index})}"></div>
                                        </th:block>
                                    </div>
                                </div>
                                <div class="meal-section flex flex-col gap-2 border-t border-dashed border-gray-100 pt-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs font-bold text-gray-400 uppercase">Dinner</span>
                                        <button onclick="addMealSlot(this, 'Dinner')" type="button" 
                                                class="text-[10px] bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-dark-ink transition-colors font-bold">
                                            + Add Item
                                        </button>
                                    </div>
                                    <div class="meal-list-container flex flex-col gap-2" data-type="Dinner">
                                        <th:block th:each="meal : ${day.meals}" th:if="${meal != null and (meal.type == 'Dinner' or meal.type == 'DINNER')}">
                                            <div th:replace="~{fragments/meal-slot-fragment::mealSlotFragment(${meal}, ${dayStat.index})}"></div>
                                        </th:block>
                                    </div>
                                </div>
                            </div>

                            <div th:if="${day.hasConflict}" class="mt-2 pt-2 border-t border-orange-200 flex justify-center">
                                <button type="button" 
                                        th:onclick="'swapDayData(' + ${dayStat.index} + ')'"
                                        class="flex items-center gap-2 text-xs font-bold text-orange-600 hover:text-orange-800 bg-orange-100 hover:bg-orange-200 px-3 py-1.5 rounded-lg transition-colors">
                                    <span class="material-symbols-outlined text-sm">swap_horiz</span>
                                    <span th:text="${day.currentSource == 'SAVED_DB'} ? 'View New Draft' : 'View Saved Plan'">Swap</span>
                                </button>

                                <input type="hidden" th:id="'alt-data-' + ${dayStat.index}" 
                                       th:value="${day.altMealsJsonString}" />
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:if="${isProfileMissing}" id="profileBlockingModal" 
     class="fixed inset-0 z-[9999] flex items-center justify-center bg-gray-900/90 backdrop-blur-sm p-4 transition-all duration-300">

    <div class="bg-white dark:bg-[#1e1e1e] rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-100 transition-all border border-gray-100 dark:border-gray-700">

        <div class="bg-orange-50 dark:bg-orange-900/20 p-8 flex justify-center items-center">
            <div class="relative">
                <span class="absolute inset-0 bg-orange-400 rounded-full opacity-20 animate-ping"></span>
                <div class="relative bg-white dark:bg-gray-800 p-4 rounded-full shadow-sm text-primary">
                    <span class="material-symbols-outlined !text-5xl">health_metrics</span>
                </div>
            </div>
        </div>

        <div class="p-8 text-center">
            <h2 class="text-2xl font-black text-dark-ink dark:text-white mb-3">Setup Required</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6 leading-relaxed">
                To generate a personalized meal plan, ZaderFood needs your body metrics (<strong>BMR, TDEE</strong>) and <strong>Calorie Goal</strong>.
            </p>

            <p class="text-xs text-orange-600 bg-orange-50 dark:bg-orange-900/10 py-2 px-3 rounded-lg mb-8 font-bold border border-orange-100 dark:border-orange-800/30">
                ⚠ Please update your settings to continue using the app.
            </p>

            <a th:href="@{/user/settings}" class="block w-full py-4 bg-primary hover:bg-orange-600 text-white font-bold rounded-xl shadow-lg shadow-orange-500/30 transition-all transform hover:-translate-y-1">
                Update Profile Now
            </a>

            <a th:href="@{/user/settings}" class="block w-full py-4 bg-white text-black font-bold rounded-xl mt-3">
                Back to home page
            </a>
        </div>
    </div>
</div>

<th:block th:replace="~{fragments/footer :: footer_section}"></th:block>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        // Kiểm tra xem modal có tồn tại không (tức là isProfileMissing = true)
        const modal = document.getElementById('profileBlockingModal');
        if (modal) {
            // Khóa cuộn của body
            document.body.style.overflow = 'hidden';
            document.body.style.height = '100vh';
        }
    });
</script>
<script>
    // Hàm thêm slot mới
    function addMealSlot(btn, type) {
        // Tìm container chứa danh sách món của bữa đó
        const container = btn.closest('.meal-section').querySelector('.meal-list-container');

        // Lấy dayIndex từ container cha lớn hơn
        const dayCard = btn.closest('.weekly-day-card');
        // Tìm một slot bất kỳ để copy dayIndex, hoặc parse từ ID cha nếu có
        // Đơn giản nhất: Tìm cal-day-X để lấy X
        const badgeId = dayCard.querySelector('.total-cal-badge').id;
        const dayIndex = badgeId.replace('cal-day-', '');

        // HTML mẫu cho slot rỗng (Copy từ HTML trên nhưng bỏ Thymeleaf)
        const newSlot = document.createElement('div');
        newSlot.className = "meal-slot relative group transition-all mt-2";
        newSlot.setAttribute('data-day-index', dayIndex);
        newSlot.setAttribute('data-meal-type', type);
        newSlot.setAttribute('ondragover', 'allowDrop(event)');
        newSlot.setAttribute('ondrop', 'drop(event)');

        newSlot.innerHTML = `
             <input type="hidden" class="input-meal-item-id" value="">
             <input type="hidden" class="input-recipe-id" value="">
        
             <button onclick="removeMealSlot(this)" type="button" 
                     class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 shadow-sm">
                 <span class="material-symbols-outlined text-[12px]">close</span>
             </button>
             <div class="flex flex-col justify-center min-h-[60px] rounded-lg border-2 border-dashed border-chef-orange bg-chef-orange/5 p-2 hover:border-primary cursor-pointer transition-colors">
                 <div class="flex justify-between items-start">
                     <p class="text-sm font-bold text-dark-ink line-clamp-1 meal-name">Drag a recipe here</p>
                     <span class="text-[10px] text-gray-400 meal-cal">0 kcal</span>
                 </div>
                 <p class="text-xs text-chef-orange mt-1 italic hint-text">Empty Slot</p>
                 <input type="hidden" class="input-recipe-id" value="">
                 <input type="hidden" class="input-recipe-name" value="Drag a recipe here">
                 <input type="hidden" class="input-recipe-cal" value="0">
             </div>
             <div class="absolute inset-0 bg-primary/10 border-2 border-primary border-dashed rounded-lg hidden pointer-events-none drop-overlay flex items-center justify-center">
                <span class="text-primary font-bold text-sm">Drop to Replace</span>
             </div>
        `;

        container.appendChild(newSlot);
    }

    // Hàm xóa slot
    function removeMealSlot(btn) {
        const slot = btn.closest('.meal-slot');
        const dayIndex = slot.getAttribute('data-day-index');

        // Lấy calo của món sắp xóa để trừ đi
        const cal = parseInt(slot.querySelector('.input-recipe-cal').value) || 0;

        // Xóa khỏi DOM
        slot.remove();

        // Cập nhật lại tổng Calo ngày
        updateDailyTotal(dayIndex, cal, 0);
    }
</script>
<script th:inline="javascript">
    // 1. Fetch Recipes từ Collection
    async function loadCollectionRecipes(collectionId) {
        const container = document.getElementById('draggableSource');
        container.innerHTML = '<p class="text-center text-sm text-gray-400">Loading...</p>';

        if (!collectionId) {
            container.innerHTML = '<p class="text-sm text-gray-400 text-center mt-10">Select a collection to view recipes.</p>';
            return;
        }

        try {
            const response = await fetch(`/api/collections/${collectionId}/recipes`);
            const recipes = await response.json();

            container.innerHTML = ''; // Clear loading

            if (recipes.length === 0) {
                container.innerHTML = '<p class="text-center text-sm text-gray-400">No recipes in this collection.</p>';
                return;
            }

            // Render Draggable Cards
            recipes.forEach(r => {
                const card = document.createElement('div');
                card.className = "flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg cursor-grab hover:shadow-md transition-all active:cursor-grabbing";
                card.draggable = true;

                // Gắn data cho sự kiện drag
                card.ondragstart = (e) => drag(e, r);

                card.innerHTML = `
                    <img src="${r.image}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=No+Img'"
                         class="w-10 h-10 rounded-full object-cover bg-gray-100 cursor-pointer hover:opacity-80"
                         onclick="window.open('/recipes/detail/${r.recipeId}', '_blank')">
                             
                    <div class="flex flex-col cursor-pointer" onclick="window.open('/recipes/detail/${r.recipeId}', '_blank')">
                        <span class="text-sm font-bold text-dark-ink line-clamp-1 hover:text-primary transition-colors">${r.name}</span>
                        <span class="text-xs text-gray-500">${r.calories} kcal</span>
                    </div>
                        
                    <span class="material-symbols-outlined text-gray-300 ml-auto text-lg">drag_indicator</span>
                `;
                container.appendChild(card);
            });

        } catch (error) {
            console.error(error);
            ZaderToast.error("Failed to load recipes");
        }
    }

    // 2. Drag & Drop Logic

    function drag(ev, recipeData) {
        // Truyền dữ liệu món ăn dưới dạng JSON string
        ev.dataTransfer.setData("text/plain", JSON.stringify(recipeData));
        ev.dataTransfer.effectAllowed = "copy"; // Chỉ copy, không move mất gốc
    }

    function allowDrop(ev) {
        ev.preventDefault(); // Bắt buộc để cho phép drop

        // Hiệu ứng visual khi kéo qua
        const slot = ev.currentTarget;
        const overlay = slot.querySelector('.drop-overlay');
        if (overlay)
            overlay.classList.remove('hidden');
    }

    // Xử lý khi chuột rời khỏi vùng drop (tắt hiệu ứng)
    document.querySelectorAll('.meal-slot').forEach(slot => {
        slot.addEventListener('dragleave', (e) => {
            const overlay = slot.querySelector('.drop-overlay');
            if (overlay)
                overlay.classList.add('hidden');
        });
    });

    function drop(ev) {
        ev.preventDefault();
        const slot = ev.currentTarget;

        // Tắt hiệu ứng overlay
        const overlay = slot.querySelector('.drop-overlay');
        if (overlay)
            overlay.classList.add('hidden');

        try {
            // Lấy dữ liệu từ thẻ được kéo
            const data = JSON.parse(ev.dataTransfer.getData("text/plain"));

            // Cập nhật UI ngay lập tức
            slot.querySelector('.meal-name').textContent = data.name;
            slot.querySelector('.meal-cal').textContent = data.calories + ' kcal';

            // Cập nhật Hidden Input (Để gửi về server nếu cần save)
            slot.querySelector('.input-recipe-id').value = data.recipeId;
            slot.querySelector('.input-recipe-name').value = data.name;

            // Cập nhật Calo cũ -> mới để tính lại tổng ngày
            const calInput = slot.querySelector('.input-recipe-cal');
            const oldCal = parseInt(calInput.value) || 0;
            const newCal = parseInt(data.calories) || 0;
            calInput.value = newCal;

            const cardDiv = slot.querySelector('div.flex.flex-col');
            cardDiv.classList.remove('border-chef-orange', 'bg-chef-orange/5');
            cardDiv.classList.add('border-nutri-green', 'bg-gray-50');

            const hintText = cardDiv.querySelector('p.text-chef-orange');
            if (hintText)
                hintText.remove();

            // Tính lại tổng calo của ngày đó
            updateDailyTotal(slot.dataset.dayIndex, oldCal, newCal);

            ZaderToast.success("Updated meal!");

        } catch (e) {
            console.error("Drop error", e);
        }
    }

    function updateDailyTotal(dayIndex, oldCal, newCal) {
        const badge = document.getElementById(`cal-day-${dayIndex}`);
        let currentTotal = parseInt(badge.getAttribute('data-value'));
        const target = /*[[${targetCalories}]]*/ 2000; // Lấy biến từ Thymeleaf

        currentTotal = currentTotal - oldCal + newCal;

        // Cập nhật lại attribute
        badge.setAttribute('data-value', currentTotal);

        // Cập nhật lại Text theo format "Current / Target kcal"
        badge.innerHTML = `
            <span>${currentTotal}</span>
            <span class="text-gray-400 mx-0.5">/</span>
            <span class="text-gray-500 dark:text-gray-400">${target}</span>
            <span class="ml-0.5">kcal</span>
        `;

        // Hiệu ứng Visual
        badge.classList.add('bg-yellow-100', 'text-yellow-700');
        setTimeout(() => {
            badge.classList.remove('bg-yellow-100', 'text-yellow-700');
            badge.classList.add('bg-gray-100', 'text-dark-ink');
        }, 500);
    }

    function savePlan() {
        const conflicts = document.querySelectorAll('.weekly-day-card[data-has-conflict="true"]');
        let warningText = 'Your plan will be saved.';

        if (conflicts.length > 0) {
            warningText = `Warning: You are overwriting ${conflicts.length} existing daily plans! The old data for these dates will be lost.`;
        }

        Swal.fire({
            title: 'Save Plan?',
            text: warningText,
            icon: conflicts.length > 0 ? 'warning' : 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Save it!',
            confirmButtonColor: conflicts.length > 0 ? '#d33' : '#4cae4f'
        }).then((result) => {
            if (result.isConfirmed) {
                // 1. Thu thập dữ liệu từ HTML
                const days = [];
                // Lặp qua từng cột ngày (Monday, Tuesday...)
                document.querySelectorAll('.weekly-day-card').forEach((dayCard, index) => {
                    const dayName = dayCard.querySelector('h3').innerText;
                    const totalCal = parseInt(dayCard.querySelector('.total-cal-badge').getAttribute('data-value')) || 0;

                    const meals = [];
                    // Lặp qua từng món trong ngày
                    dayCard.querySelectorAll('.meal-slot').forEach(slot => {
                        const type = slot.getAttribute('data-meal-type');
                        const recipeId = slot.querySelector('.input-recipe-id').value;
                        const recipeName = slot.querySelector('.input-recipe-name').value;
                        const calories = parseInt(slot.querySelector('.input-recipe-cal').value) || 0;

                        const mealItemId = slot.querySelector('.input-meal-item-id').value;

                        meals.push({
                            mealItemId: mealItemId ? parseInt(mealItemId) : null,
                            type: type,
                            recipeId: recipeId ? parseInt(recipeId) : null,
                            recipeName: recipeName,
                            calories: calories
                        });
                    });

                    days.push({
                        dayName: dayName,
                        totalCalories: totalCal,
                        meals: meals
                    });
                });

                const payload = {days: days};

                // 2. Gửi về Server
                fetch('/meal-plan/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                                // Thêm CSRF token nếu project có bật CSRF protection
                    },
                    body: JSON.stringify(payload)
                })
                        .then(response => {
                            if (response.ok) {
                                ZaderToast.success("Plan saved successfully!");
                                // Có thể redirect về trang quản lý lịch ăn
                                // window.location.href = '/user/meal-plans'; 
                            } else {
                                ZaderToast.error("Failed to save plan.");
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            ZaderToast.error("Network error.");
                        });
            }
        });
    }


    // === CLIENT-SIDE SEARCH LOGIC ===

    // 1. Biến toàn cục chứa danh sách gốc
    let allRecipesGlobal = [];

    // 2. Hàm khởi tạo: Chạy ngay khi load trang
    document.addEventListener('DOMContentLoaded', async function () {
        await fetchAllRecipes();
    });

    async function fetchAllRecipes() {
        const container = document.getElementById('miniSearchResults');
        container.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">Loading recipes...</p>';

        try {
            // Gọi API lấy toàn bộ danh sách
            const response = await fetch('/recipes/all-mini');
            if (response.ok) {
                allRecipesGlobal = await response.json();

                // Render lần đầu (hiện tất cả hoặc rỗng tùy bạn)
                renderRecipes(allRecipesGlobal);
            } else {
                container.innerHTML = '<p class="text-center text-xs text-red-400">Failed to load data.</p>';
            }
        } catch (error) {
            console.error(error);
            container.innerHTML = '<p class="text-center text-xs text-red-400">Connection error.</p>';
        }
    }

    // 3. Hàm Lọc (Search Local)
    function performLocalSearch() {
        const keyword = document.getElementById('miniSearchKeyword').value.toLowerCase();
        const maxCal = parseInt(document.getElementById('miniSearchCal').value) || 2000;

        // Lọc mảng trong bộ nhớ máy khách
        const filtered = allRecipesGlobal.filter(r => {
            const matchesName = r.name.toLowerCase().includes(keyword);
            const matchesCal = r.calories <= maxCal;
            return matchesName && matchesCal;
        });

        renderRecipes(filtered);
    }

    // 4. Hàm Render ra HTML
    function renderRecipes(recipeList) {
        const container = document.getElementById('miniSearchResults');
        container.innerHTML = ''; // Clear previous results

        if (recipeList.length === 0) {
            container.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">No recipes match.</p>';
            return;
        }

        recipeList.forEach(r => {
            const card = document.createElement('div');

            // --- Style & Drag Attributes ---
            card.className = "relative flex items-center gap-3 p-2 bg-white border border-gray-200 rounded-lg cursor-grab hover:shadow-sm transition-all active:cursor-grabbing group";
            card.draggable = true;

            // Attach Drag Event
            card.ondragstart = (e) => drag(e, r);

            // --- HTML Content ---
            // We add an <a> tag wrapping the image or a specific view button
            card.innerHTML = `
            <div class="relative w-10 h-10 shrink-0 group/img cursor-pointer">
                <img src="${r.image}" 
                     class="w-full h-full rounded-full object-cover bg-gray-100" 
                     onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=No+Img'"
                     onclick="window.open('/recipes/detail/${r.recipeId}', '_blank')"> <div class="absolute inset-0 bg-black/20 rounded-full hidden group-hover/img:flex items-center justify-center pointer-events-none">
                    <span class="material-symbols-outlined text-white text-[10px]">visibility</span>
                </div>
            </div>
                
            <div class="flex flex-col min-w-0 flex-1 cursor-pointer" onclick="window.open('/recipes/detail/${r.recipeId}', '_blank')">
                <span class="text-xs font-bold text-dark-ink truncate w-full group-hover:text-primary transition-colors" title="${r.name}">${r.name}</span>
                <span class="text-[10px] text-gray-500">${r.calories || 0} kcal</span>
            </div>
                
            <span class="material-symbols-outlined text-gray-300 text-base" title="Drag to plan">drag_indicator</span>
        `;
            container.appendChild(card);
        });
    }

    // 5. Kết nối sự kiện vào Input HTML
    // (Thay thế debounceSearch cũ bằng hàm này)
    function onSearchInput() {
        performLocalSearch();
    }

    function onCalorieChange(val) {
        document.getElementById('calLabel').textContent = val;
        performLocalSearch();
    }

    // --- SWAP LOGIC (Hoán đổi dữ liệu Cũ/Mới) ---
    function swapDayData(dayIndex) {
        try {
            // 1. Lấy Elements
            const mealsContainer = document.getElementById(`meals-container-${dayIndex}`);
            const altDataInput = document.getElementById(`alt-data-${dayIndex}`);
            const dayCard = mealsContainer.closest('.weekly-day-card');
            const swapBtnText = dayCard.querySelector('button span:last-child');
            const sourceTag = dayCard.querySelector('.flex.flex-col span.text-\\[10px\\]');
            const calBadge = document.getElementById(`cal-day-${dayIndex}`);

            // 2. Thu thập dữ liệu HIỆN TẠI (Current -> Backup)
            const currentMeals = [];
            mealsContainer.querySelectorAll('.meal-slot').forEach(slot => {
                const rId = slot.querySelector('.input-recipe-id').value;
                const rName = slot.querySelector('.input-recipe-name').value;
                const rCal = parseInt(slot.querySelector('.input-recipe-cal').value) || 0;
                const type = slot.getAttribute('data-meal-type'); // Quan trọng: Lấy đúng type

                currentMeals.push({
                    recipeId: rId ? parseInt(rId) : null,
                    recipeName: rName,
                    calories: rCal,
                    type: type
                });
            });
            const currentTotalCal = parseInt(calBadge.getAttribute('data-value')) || 0;

            // 3. Lấy dữ liệu DỰ PHÒNG (Backup -> New Current)
            const altMeals = JSON.parse(altDataInput.value);
            const altTotalCal = parseInt(dayCard.getAttribute('data-alt-cal')) || 0;

            // 4. SWAP DATA
            altDataInput.value = JSON.stringify(currentMeals);
            dayCard.setAttribute('data-alt-cal', currentTotalCal);

            // 5. RENDER LẠI UI THEO CẤU TRÚC MỚI (3 SECTIONS)
            mealsContainer.innerHTML = ''; // Clear cũ

            // Định nghĩa các bữa ăn
            const mealTypes = ['Breakfast', 'Lunch', 'Dinner'];

            mealTypes.forEach((type, index) => {
                // Lọc các món thuộc bữa này
                const mealsForType = altMeals.filter(m =>
                    m.type && m.type.toUpperCase() === type.toUpperCase()
                );

                // Tạo Header Section (Có nút Add Item)
                const section = document.createElement('div');
                section.className = "meal-section flex flex-col gap-2";
                if (index > 0)
                    section.classList.add("border-t", "border-dashed", "border-gray-100", "pt-2");

                const header = `
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-400 uppercase">${type}</span>
                        <button onclick="addMealSlot(this, '${type}')" type="button" 
                                class="text-[10px] bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-dark-ink transition-colors font-bold">
                            + Add Item
                        </button>
                    </div>
                    <div class="meal-list-container flex flex-col gap-2" data-type="${type}"></div>
                `;
                section.innerHTML = header;
                mealsContainer.appendChild(section);

                // Render từng món ăn vào list
                const listContainer = section.querySelector('.meal-list-container');

                mealsForType.forEach(meal => {
                    const isEmpty = !meal.recipeId;
                    // HTML cho slot món ăn (Giống hệt addMealSlot nhưng có dữ liệu)
                    const slotHtml = `
                        <div class="meal-slot relative group transition-all mt-1"
                             data-day-index="${dayIndex}"
                             data-meal-type="${meal.type}"
                             ondragover="allowDrop(event)"
                             ondrop="drop(event)">

                            <button onclick="removeMealSlot(this)" type="button" 
                                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-20 shadow-sm cursor-pointer">
                                <span class="material-symbols-outlined text-[12px]">close</span>
                            </button>

                            <div class="flex flex-col justify-center min-h-[60px] rounded-lg border-2 border-dashed p-2 hover:border-primary cursor-pointer transition-colors relative z-10
                                        ${isEmpty ? 'border-chef-orange bg-chef-orange/5' : 'border-nutri-green bg-gray-50'}">
                                
                                <div class="flex justify-between items-start pointer-events-none">
                                    <p class="text-sm font-bold text-dark-ink line-clamp-1 meal-name">${meal.recipeName}</p>
                                    <span class="text-[10px] text-gray-400 meal-cal">${meal.calories} kcal</span>
                                </div>
                                
                                ${isEmpty ? '<p class="text-xs text-chef-orange mt-1 italic hint-text pointer-events-none">Drag recipe here</p>' : ''}

                                <input type="hidden" class="input-recipe-id" name="days[${dayIndex}].meals[].recipeId" value="${meal.recipeId || ''}">
                                <input type="hidden" class="input-recipe-name" name="days[${dayIndex}].meals[].recipeName" value="${meal.recipeName}">
                                <input type="hidden" class="input-recipe-cal" name="days[${dayIndex}].meals[].calories" value="${meal.calories}">
                            </div>
                            
                            <div class="absolute inset-0 bg-primary/10 border-2 border-primary border-dashed rounded-lg hidden pointer-events-none drop-overlay flex items-center justify-center z-30">
                                <span class="text-primary font-bold text-sm">Drop to Replace</span>
                            </div>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', slotHtml);
                });
            });

            // 6. Cập nhật Badge Tổng Calo & Nút Bấm (Giữ nguyên logic cũ)
            const targetCalText = calBadge.innerText.split('/')[1].trim();
            const targetCal = targetCalText.replace('kcal', '').trim(); // Xóa chữ kcal cũ đi

            calBadge.innerHTML = `<span>${altTotalCal}</span> / ${targetCal} kcal`;
            calBadge.setAttribute('data-value', altTotalCal);

            const currentSource = dayCard.getAttribute('data-current-source');
            if (currentSource === 'SAVED_DB') {
                dayCard.setAttribute('data-current-source', 'NEW_AI');
                swapBtnText.innerText = 'View Saved Plan';
                sourceTag.innerText = 'NEW DRAFT';
                sourceTag.className = 'text-[10px] font-bold text-white bg-blue-500 px-2 py-0.5 rounded w-fit';
            } else {
                dayCard.setAttribute('data-current-source', 'SAVED_DB');
                swapBtnText.innerText = 'View New Draft';
                sourceTag.innerText = 'SAVED IN DB';
                sourceTag.className = 'text-[10px] font-bold text-white bg-green-600 px-2 py-0.5 rounded w-fit';
            }

            ZaderToast.success("Swapped plan version");

        } catch (e) {
            console.error(e);
            ZaderToast.error("Error swapping data");
        }
    }
</script>
</body>
</html>