<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{fragments/head :: common-head}">
        <title>Customize Meal Plan</title>
    </head>
    <body class="flex flex-col min-h-screen bg-smart-white dark:bg-background-dark font-display">

    <th:block th:replace="~{fragments/toast :: toast-system}"></th:block>
    <th:block th:replace="~{fragments/navbar :: header_nav}"></th:block>

    <main class="flex-grow px-4 sm:px-6 lg:px-10 py-8">
        <div class="mx-auto flex max-w-[1400px] flex-col gap-8">

            <div class="flex flex-wrap justify-between gap-3 p-4">
                <div class="flex min-w-72 flex-col gap-2">
                    <h1 class="text-dark-ink dark:text-white text-4xl font-black">Your Weekly Plan</h1>
                    <p class="text-gray-500">Review and customize your AI-generated schedule.</p>
                </div>
                <div class="flex gap-3">
                    <a href="/meal-plan/generate" class="flex items-center justify-center gap-2 h-10 px-6 rounded-lg bg-gray-200 text-dark-ink text-sm font-bold">
                        <span class="material-symbols-outlined text-base">refresh</span> Regenerate
                    </a>
                    <button onclick="savePlan()" class="flex items-center justify-center h-10 px-8 rounded-lg bg-chef-orange text-white text-sm font-bold shadow-lg shadow-chef-orange/20">
                        Save to Account
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                <div class="lg:col-span-3 flex flex-col gap-6 sticky top-24">
                    <div class="bg-white dark:bg-background-dark rounded-xl shadow-soft p-6 flex flex-col gap-4">
                        <div class="flex justify-between items-center cursor-pointer" onclick="toggleSearchPanel()">
                            <h2 class="text-dark-ink dark:text-white text-lg font-bold">Find Recipes</h2>
                            <span id="toggleIcon" class="material-symbols-outlined text-gray-400 transform transition-transform">expand_less</span>
                        </div>

                        <div id="searchPanelContent" class="flex flex-col gap-4 transition-all duration-300">
                            <div class="flex flex-col gap-3">
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                                        <span class="material-symbols-outlined text-lg">search</span>
                                    </span>
                                    <input type="text" id="miniSearchKeyword" placeholder="Search by name..." 
                                           class="w-full pl-10 pr-3 py-2 rounded-lg border border-gray-200 text-sm focus:ring-primary focus:border-primary"
                                           onkeyup="onSearchInput()"> </div>

                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500 font-bold">Max Cal:</span>
                                    <input type="range" id="miniSearchCal" min="100" max="2000" step="50" value="2000"
                                           class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"
                                           oninput="onCalorieChange(this.value)">
                                    <span id="calLabel" class="text-xs font-bold text-primary w-12 text-right">2000</span>
                                </div>
                            </div>

                            <div id="miniSearchResults" class="flex flex-col gap-3 overflow-y-auto pr-1 max-h-[300px] min-h-[100px] border-t border-gray-100 pt-3">
                                <p class="text-xs text-gray-400 text-center mt-4">Type to search...</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-background-dark rounded-xl shadow-soft p-6 flex flex-col gap-4 max-h-[600px]">
                        <div class="flex justify-between items-center">
                            <h2 class="text-dark-ink dark:text-white text-lg font-bold">My Collections</h2>
                        </div>

                        <select id="collectionSelect" onchange="loadCollectionRecipes(this.value)"
                                class="w-full rounded-lg border-gray-200 text-sm focus:ring-primary focus:border-primary">
                            <option value="">-- Select a Collection --</option>
                            <th:block th:each="col : ${myCollections}">
                                <option th:value="${col.collectionId}" th:text="${col.name}">My Favorites</option>
                            </th:block>
                        </select>

                        <div id="draggableSource" class="flex flex-col gap-3 overflow-y-auto pr-1 flex-1 min-h-[300px]">
                            <p class="text-sm text-gray-400 text-center mt-10">Select a collection to view recipes.</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-9 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">

                    <th:block th:each="day, dayStat : ${weeklyPlan.days}">
                        <div class="weekly-day-card flex flex-col gap-4 bg-white dark:bg-[#1e1e1e] p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">

                            <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                                <h3 class="font-bold text-lg text-primary" th:text="${day.dayName}">Monday</h3>

                                <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-xs font-bold text-dark-ink dark:text-white total-cal-badge"
                                     th:id="'cal-day-' + ${dayStat.index}"
                                     th:data-value="${day.totalCalories}">

                                    <span th:text="${day.totalCalories}">1500</span>
                                    <span class="text-gray-400 mx-0.5">/</span>
                                    <span th:text="${targetCalories}" class="text-gray-500 dark:text-gray-400">2000</span>
                                    <span class="ml-0.5">kcal</span>
                                </div>
                            </div>

                            <div class="flex flex-col gap-3">
                                <div th:each="meal, mealStat : ${day.meals}">

                                    <div class="meal-slot relative group transition-all"
                                         th:data-day-index="${dayStat.index}"
                                         th:data-meal-type="${meal.type}"
                                         ondragover="allowDrop(event)"
                                         ondrop="drop(event)">

                                        <div th:classappend="${meal.recipeId == null} ? 'border-chef-orange bg-chef-orange/5' : 'border-nutri-green bg-gray-50'"
                                             class="flex flex-col justify-center min-h-[90px] rounded-lg border-2 border-dashed p-3 hover:border-primary cursor-pointer transition-colors">

                                            <div class="flex justify-between items-start">
                                                <p class="text-xs font-bold text-soft-grey uppercase" th:text="${meal.type}">Breakfast</p>
                                                <span class="text-[10px] text-gray-400 meal-cal" th:text="${meal.calories + ' kcal'}"></span>
                                            </div>

                                            <p class="text-sm font-bold text-dark-ink mt-1 line-clamp-2 meal-name" 
                                               th:text="${meal.recipeName}">Recipe Name</p>

                                            <p th:if="${meal.recipeId == null}" class="text-xs text-chef-orange mt-1 italic">
                                                Drag a recipe here
                                            </p>

                                            <input type="hidden" class="input-recipe-id" th:name="|days[${dayStat.index}].meals[${mealStat.index}].recipeId|" th:value="${meal.recipeId}">
                                            <input type="hidden" class="input-recipe-name" th:name="|days[${dayStat.index}].meals[${mealStat.index}].recipeName|" th:value="${meal.recipeName}">
                                            <input type="hidden" class="input-recipe-cal" th:name="|days[${dayStat.index}].meals[${mealStat.index}].calories|" th:value="${meal.calories}">
                                        </div>

                                        <div class="absolute inset-0 bg-primary/10 border-2 border-primary border-dashed rounded-lg hidden pointer-events-none drop-overlay flex items-center justify-center">
                                            <span class="text-primary font-bold text-sm">Drop to Replace</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </th:block>

                </div>
            </div>
        </div>
    </main>

    <th:block th:replace="~{fragments/footer :: footer_section}"></th:block>

    <script th:inline="javascript">
        // 1. Fetch Recipes từ Collection
        async function loadCollectionRecipes(collectionId) {
            const container = document.getElementById('draggableSource');
            container.innerHTML = '<p class="text-center text-sm text-gray-400">Loading...</p>';

            if (!collectionId) {
                container.innerHTML = '<p class="text-sm text-gray-400 text-center mt-10">Select a collection to view recipes.</p>';
                return;
            }

            try {
                const response = await fetch(`/api/collections/${collectionId}/recipes`);
                const recipes = await response.json();

                container.innerHTML = ''; // Clear loading

                if (recipes.length === 0) {
                    container.innerHTML = '<p class="text-center text-sm text-gray-400">No recipes in this collection.</p>';
                    return;
                }

                // Render Draggable Cards
                recipes.forEach(r => {
                    const card = document.createElement('div');
                    card.className = "flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg cursor-grab hover:shadow-md transition-all active:cursor-grabbing";
                    card.draggable = true;

                    // Gắn data cho sự kiện drag
                    card.ondragstart = (e) => drag(e, r);

                    card.innerHTML = `
                        <img src="${r.image}" 
                             class="w-10 h-10 rounded-full object-cover bg-gray-100 cursor-pointer hover:opacity-80"
                             onclick="window.open('/recipes/detail/${r.recipeId}', '_blank')">
                             
                        <div class="flex flex-col cursor-pointer" onclick="window.open('/recipes/detail/${r.recipeId}', '_blank')">
                            <span class="text-sm font-bold text-dark-ink line-clamp-1 hover:text-primary transition-colors">${r.name}</span>
                            <span class="text-xs text-gray-500">${r.calories} kcal</span>
                        </div>
                        
                        <span class="material-symbols-outlined text-gray-300 ml-auto text-lg">drag_indicator</span>
                    `;
                    container.appendChild(card);
                });

            } catch (error) {
                console.error(error);
                ZaderToast.error("Failed to load recipes");
            }
        }

        // 2. Drag & Drop Logic

        function drag(ev, recipeData) {
            // Truyền dữ liệu món ăn dưới dạng JSON string
            ev.dataTransfer.setData("text/plain", JSON.stringify(recipeData));
            ev.dataTransfer.effectAllowed = "copy"; // Chỉ copy, không move mất gốc
        }

        function allowDrop(ev) {
            ev.preventDefault(); // Bắt buộc để cho phép drop

            // Hiệu ứng visual khi kéo qua
            const slot = ev.currentTarget;
            const overlay = slot.querySelector('.drop-overlay');
            if (overlay)
                overlay.classList.remove('hidden');
        }

        // Xử lý khi chuột rời khỏi vùng drop (tắt hiệu ứng)
        document.querySelectorAll('.meal-slot').forEach(slot => {
            slot.addEventListener('dragleave', (e) => {
                const overlay = slot.querySelector('.drop-overlay');
                if (overlay)
                    overlay.classList.add('hidden');
            });
        });

        function drop(ev) {
            ev.preventDefault();
            const slot = ev.currentTarget;

            // Tắt hiệu ứng overlay
            const overlay = slot.querySelector('.drop-overlay');
            if (overlay)
                overlay.classList.add('hidden');

            try {
                // Lấy dữ liệu từ thẻ được kéo
                const data = JSON.parse(ev.dataTransfer.getData("text/plain"));

                // Cập nhật UI ngay lập tức
                slot.querySelector('.meal-name').textContent = data.name;
                slot.querySelector('.meal-cal').textContent = data.calories + ' kcal';

                // Cập nhật Hidden Input (Để gửi về server nếu cần save)
                slot.querySelector('.input-recipe-id').value = data.recipeId;
                slot.querySelector('.input-recipe-name').value = data.name;

                // Cập nhật Calo cũ -> mới để tính lại tổng ngày
                const calInput = slot.querySelector('.input-recipe-cal');
                const oldCal = parseInt(calInput.value) || 0;
                const newCal = parseInt(data.calories) || 0;
                calInput.value = newCal;

                const cardDiv = slot.querySelector('div.flex.flex-col');
                cardDiv.classList.remove('border-chef-orange', 'bg-chef-orange/5');
                cardDiv.classList.add('border-nutri-green', 'bg-gray-50');

                const hintText = cardDiv.querySelector('p.text-chef-orange');
                if (hintText)
                    hintText.remove();

                // Tính lại tổng calo của ngày đó
                updateDailyTotal(slot.dataset.dayIndex, oldCal, newCal);

                ZaderToast.success("Updated meal!");

            } catch (e) {
                console.error("Drop error", e);
            }
        }

        function updateDailyTotal(dayIndex, oldCal, newCal) {
            const badge = document.getElementById(`cal-day-${dayIndex}`);
            let currentTotal = parseInt(badge.getAttribute('data-value'));
            const target = /*[[${targetCalories}]]*/ 2000; // Lấy biến từ Thymeleaf

            currentTotal = currentTotal - oldCal + newCal;

            // Cập nhật lại attribute
            badge.setAttribute('data-value', currentTotal);

            // Cập nhật lại Text theo format "Current / Target kcal"
            badge.innerHTML = `
                <span>${currentTotal}</span>
                <span class="text-gray-400 mx-0.5">/</span>
                <span class="text-gray-500 dark:text-gray-400">${target}</span>
                <span class="ml-0.5">kcal</span>
            `;

            // Hiệu ứng Visual
            badge.classList.add('bg-yellow-100', 'text-yellow-700');
            setTimeout(() => {
                badge.classList.remove('bg-yellow-100', 'text-yellow-700');
                badge.classList.add('bg-gray-100', 'text-dark-ink');
            }, 500);
        }

        function savePlan() {
            Swal.fire({
                title: 'Save Changes?',
                text: 'Your customized plan will be saved to your account starting from tomorrow.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Save',
                confirmButtonColor: '#4cae4f'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 1. Thu thập dữ liệu từ HTML
                    const days = [];
                    // Lặp qua từng cột ngày (Monday, Tuesday...)
                    document.querySelectorAll('.weekly-day-card').forEach((dayCard, index) => {
                        const dayName = dayCard.querySelector('h3').innerText;
                        const totalCal = parseInt(dayCard.querySelector('.total-cal-badge').getAttribute('data-value')) || 0;

                        const meals = [];
                        // Lặp qua từng món trong ngày
                        dayCard.querySelectorAll('.meal-slot').forEach(slot => {
                            const type = slot.getAttribute('data-meal-type');
                            const recipeId = slot.querySelector('.input-recipe-id').value;
                            const recipeName = slot.querySelector('.input-recipe-name').value;
                            const calories = parseInt(slot.querySelector('.input-recipe-cal').value) || 0;

                            meals.push({
                                type: type,
                                recipeId: recipeId ? parseInt(recipeId) : null,
                                recipeName: recipeName,
                                calories: calories
                            });
                        });

                        days.push({
                            dayName: dayName,
                            totalCalories: totalCal,
                            meals: meals
                        });
                    });

                    const payload = {days: days};

                    // 2. Gửi về Server
                    fetch('/meal-plan/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                                    // Thêm CSRF token nếu project có bật CSRF protection
                        },
                        body: JSON.stringify(payload)
                    })
                            .then(response => {
                                if (response.ok) {
                                    ZaderToast.success("Plan saved successfully!");
                                    // Có thể redirect về trang quản lý lịch ăn
                                    // window.location.href = '/user/meal-plans'; 
                                } else {
                                    ZaderToast.error("Failed to save plan.");
                                }
                            })
                            .catch(err => {
                                console.error(err);
                                ZaderToast.error("Network error.");
                            });
                }
            });
        }


        // === CLIENT-SIDE SEARCH LOGIC ===

        // 1. Biến toàn cục chứa danh sách gốc
        let allRecipesGlobal = [];

        // 2. Hàm khởi tạo: Chạy ngay khi load trang
        document.addEventListener('DOMContentLoaded', async function () {
            await fetchAllRecipes();
        });

        async function fetchAllRecipes() {
            const container = document.getElementById('miniSearchResults');
            container.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">Loading recipes...</p>';

            try {
                // Gọi API lấy toàn bộ danh sách
                const response = await fetch('/recipes/all-mini');
                if (response.ok) {
                    allRecipesGlobal = await response.json();

                    // Render lần đầu (hiện tất cả hoặc rỗng tùy bạn)
                    renderRecipes(allRecipesGlobal);
                } else {
                    container.innerHTML = '<p class="text-center text-xs text-red-400">Failed to load data.</p>';
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = '<p class="text-center text-xs text-red-400">Connection error.</p>';
            }
        }

        // 3. Hàm Lọc (Search Local)
        function performLocalSearch() {
            const keyword = document.getElementById('miniSearchKeyword').value.toLowerCase();
            const maxCal = parseInt(document.getElementById('miniSearchCal').value) || 2000;

            // Lọc mảng trong bộ nhớ máy khách
            const filtered = allRecipesGlobal.filter(r => {
                const matchesName = r.name.toLowerCase().includes(keyword);
                const matchesCal = r.calories <= maxCal;
                return matchesName && matchesCal;
            });

            renderRecipes(filtered);
        }

        // 4. Hàm Render ra HTML
        function renderRecipes(recipeList) {
            const container = document.getElementById('miniSearchResults');
            container.innerHTML = ''; // Clear previous results

            if (recipeList.length === 0) {
                container.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">No recipes match.</p>';
                return;
            }

            recipeList.forEach(r => {
                const card = document.createElement('div');

                // --- Style & Drag Attributes ---
                card.className = "relative flex items-center gap-3 p-2 bg-white border border-gray-200 rounded-lg cursor-grab hover:shadow-sm transition-all active:cursor-grabbing group";
                card.draggable = true;

                // Attach Drag Event
                card.ondragstart = (e) => drag(e, r);

                // --- HTML Content ---
                // We add an <a> tag wrapping the image or a specific view button
                card.innerHTML = `
                <div class="relative w-10 h-10 shrink-0 group/img cursor-pointer">
                    <img src="${r.image}" 
                         class="w-full h-full rounded-full object-cover bg-gray-100" 
                         onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=No+Img'"
                         onclick="window.open('/recipes/detail/${r.recipeId}', '_blank')"> <div class="absolute inset-0 bg-black/20 rounded-full hidden group-hover/img:flex items-center justify-center pointer-events-none">
                        <span class="material-symbols-outlined text-white text-[10px]">visibility</span>
                    </div>
                </div>
                
                <div class="flex flex-col min-w-0 flex-1 cursor-pointer" onclick="window.open('/recipes/detail/${r.recipeId}', '_blank')">
                    <span class="text-xs font-bold text-dark-ink truncate w-full group-hover:text-primary transition-colors" title="${r.name}">${r.name}</span>
                    <span class="text-[10px] text-gray-500">${r.calories || 0} kcal</span>
                </div>
                
                <span class="material-symbols-outlined text-gray-300 text-base" title="Drag to plan">drag_indicator</span>
            `;
                container.appendChild(card);
            });
        }

        // 5. Kết nối sự kiện vào Input HTML
        // (Thay thế debounceSearch cũ bằng hàm này)
        function onSearchInput() {
            performLocalSearch();
        }

        function onCalorieChange(val) {
            document.getElementById('calLabel').textContent = val;
            performLocalSearch();
        }
    </script>
</body>
</html>