<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
        <title>Categories - Zader Admin</title>
        <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
        <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <style>.material-symbols-outlined {
                font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            }</style>
        <script>tailwind.config = {darkMode: "class", theme: {extend: {colors: {"primary": "#4bbe4f", "nutri-green": "#4CAF50"}, fontFamily: {"display": ["Manrope", "sans-serif"]}}}}</script>
    </head>
    <body class="font-display bg-gray-50 text-gray-800">

        <div class="relative flex min-h-screen w-full">
            <div th:replace="${isNutritionist} ? ~{fragments/sidebar_nutritionist :: sidebar} : ~{fragments/sidebar :: sidebar}"></div>

            <main class="flex-1 ml-64 bg-gray-50 min-h-screen">
                <div th:replace="~{fragments/navbar_admin :: header_nav_admin}"></div>
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-extrabold">Categories</h2>

                        <form th:action="@{/admin/categories/add}" method="post" class="flex gap-2">
                            <input type="text" name="name" required placeholder="New Category Name" class="rounded-lg border-gray-300 h-10 text-sm focus:ring-nutri-green w-64">
                            <button type="submit" class="flex items-center rounded-lg h-10 px-4 bg-nutri-green text-white font-bold hover:bg-green-600 transition shadow-sm">
                                <span class="material-symbols-outlined text-sm mr-1">add</span> Add
                            </button>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden max-w-3xl">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 border-b border-gray-100 text-gray-500 uppercase">
                                <tr>
                                    <th class="p-4 w-20">ID</th>
                                    <th class="p-4">Name</th>
                                    <th class="p-4 w-40">Created At</th>
                                    <th class="p-4 w-40 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr th:each="cat : ${categories}" class="hover:bg-gray-50 transition group">
                                    <td class="p-4 text-gray-500" th:text="${cat.categoryId}">1</td>
                                    <td class="p-4 font-bold text-dark-ink" th:text="${cat.name}">Meat</td>
                                    <td class="p-4 text-gray-500" th:text="${#temporals.format(cat.createdAt, 'dd/MM/yyyy')}">2024</td>
                                    <td class="p-4 text-right">
                                        <div class="flex justify-end gap-3 opacity-100 transition-opacity">

                                            <button type="button" 
                                                    th:data-id="${cat.categoryId}"
                                                    th:data-name="${cat.name}"
                                                    onclick="openEditModal(this.getAttribute('data-id'), this.getAttribute('data-name'))"
                                                    class="text-blue-600 hover:text-blue-800 font-bold text-xs uppercase flex items-center gap-1 transition">
                                                <span class="material-symbols-outlined text-sm">edit</span> Edit
                                            </button>

                                            <form th:id="'delete-cat-' + ${cat.categoryId}" 
                                                  th:action="@{/admin/categories/delete/{id}(id=${cat.categoryId})}" 
                                                  method="post" style="display: none;">
                                            </form>

                                            <button type="button" 
                                                    th:data-id="${cat.categoryId}"
                                                    onclick="confirmAction('delete-cat-' + this.getAttribute('data-id'), 'Delete Category?', 'Category will be hard deleted if not in use, otherwise soft deleted.', 'Yes, Delete')"
                                                    class="text-red-500 hover:text-red-700 font-bold text-xs uppercase flex items-center gap-1 transition">
                                                <span class="material-symbols-outlined text-sm">delete</span> Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${categories.empty}">
                                    <td colspan="4" class="p-8 text-center text-gray-500">No categories found. Add one above!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <dialog id="editModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/40 w-full max-w-md open:animate-fade-in">
            <form th:action="@{/admin/categories/update}" method="post" class="flex flex-col">
                <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-dark-ink">Edit Category</h3>
                    <button type="button" onclick="document.getElementById('editModal').close()" class="text-gray-400 hover:text-gray-600 transition">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="p-6 flex flex-col gap-4">
                    <input type="hidden" id="editCategoryId" name="id" />

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Category Name</label>
                        <input type="text" id="editCategoryName" name="name" required class="w-full rounded-lg border-gray-300 focus:ring-nutri-green focus:border-nutri-green"/>
                    </div>
                </div>

                <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('editModal').close()" class="px-4 py-2 rounded-lg text-gray-600 font-bold hover:bg-gray-200 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-nutri-green text-white font-bold hover:bg-green-600 shadow-sm transition">Save Changes</button>
                </div>
            </form>
        </dialog>

        <div th:replace="~{fragments/toast :: toast-system}"></div>

        <script>
            // Hàm mở Modal và điền dữ liệu
            function openEditModal(id, name) {
                document.getElementById('editCategoryId').value = id;
                document.getElementById('editCategoryName').value = name;
                document.getElementById('editModal').showModal();
            }

            // Hàm Confirm dùng SweetAlert (Đã có sẵn trong toast.html nhưng nếu file đó chưa cập nhật thì dùng đoạn này dự phòng)
            function confirmAction(formId, title = 'Are you sure?', text = "You won't be able to revert this!", confirmBtnText = 'Yes, do it!') {
                if (typeof Swal === 'undefined') {
                    if (confirm(title + "\n" + text))
                        document.getElementById(formId).submit();
                    return;
                }
                Swal.fire({
                    title: title,
                    text: text,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#111827',
                    cancelButtonColor: '#d33',
                    confirmButtonText: confirmBtnText,
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (typeof ZaderToast !== 'undefined')
                            ZaderToast.loading('Processing...');
                        document.getElementById(formId).submit();
                    }
                });
            }
        </script>
    </body>
</html>