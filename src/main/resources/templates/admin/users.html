<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
        <title>User Management - Zader Admin</title>

        <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
        <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <style>
            .material-symbols-outlined {
                font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            }
        </style>
        <script id="tailwind-config">
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {"primary": "#4bbe4f", "background-light": "#FAFAFA", "dark-ink": "#263238", "nutri-green": "#4CAF50", "alert-red": "#EF4444"},
                        fontFamily: {"display": ["Manrope", "sans-serif"]},
                    },
                },
            }
        </script>
    </head>
    <body class="font-display bg-background-light text-dark-ink">
        <div class="relative flex min-h-screen w-full overflow-x-hidden group/design-root">

            <div th:replace="~{fragments/sidebar :: sidebar}"></div>

            <main class="flex-1 ml-64 bg-gray-50 min-h-screen">
                <div th:replace="~{fragments/navbar_admin :: header_nav_admin}"></div>
                <div class="p-8">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h2 class="text-3xl font-extrabold text-dark-ink">User Management</h2>
                            <p class="text-gray-500 mt-1">Manage, filter and export all registered users.</p>
                        </div>
                        <button onclick="document.getElementById('addUserModal').showModal()" 
                                class="flex items-center justify-center rounded-lg h-10 px-5 bg-nutri-green text-white font-bold gap-2 hover:bg-green-600 transition-colors shadow-sm">
                            <span class="material-symbols-outlined text-sm">add</span>
                            <span>Add New User</span>
                        </button>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <form th:action="@{/admin/users}" method="get" class="flex flex-col md:flex-row gap-4 items-center">
                            <div class="relative flex-1 w-full">
                                <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-400">search</span>
                                <input name="keyword" th:value="${keyword}" class="w-full rounded-lg border-gray-200 pl-10 h-10 focus:ring-nutri-green focus:border-nutri-green text-sm" placeholder="Search by name or email..." type="text"/>
                            </div>
                            <select name="role" class="rounded-lg border-gray-200 h-10 text-sm focus:ring-nutri-green" onchange="this.form.submit()">
                                <option value="">All Roles</option>
                                <option th:each="r : ${roles}" th:value="${r}" th:text="${r}" th:selected="${r == role}"></option>
                            </select>
                            <select name="status" class="rounded-lg border-gray-200 h-10 text-sm focus:ring-nutri-green" onchange="this.form.submit()">
                                <option value="">All Status</option>
                                <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}" th:selected="${s == status}"></option>
                            </select>
                            <a th:href="@{/admin/users/export}" class="flex items-center justify-center rounded-lg h-10 px-4 bg-gray-100 border border-gray-200 font-medium text-sm gap-2 hover:bg-gray-200 transition">
                                <span class="material-symbols-outlined text-sm">download</span>
                                <span>Export Excel</span>
                            </a>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50 border-b border-gray-100 text-gray-500 uppercase tracking-wider">
                                    <tr>
                                        <th class="p-4 font-semibold">User Info</th>
                                        <th class="p-4 font-semibold">Status</th>
                                        <th class="p-4 font-semibold">Role</th>
                                        <th class="p-4 font-semibold">Joined Date</th>
                                        <th class="p-4 font-semibold text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr th:each="user : ${users}" class="hover:bg-gray-50 transition">
                                        <td class="p-4">
                                            <div class="flex items-center gap-3">
                                                <div class="bg-nutri-green/10 text-nutri-green rounded-full size-10 flex items-center justify-center font-bold text-lg">
                                                    <span th:text="${#strings.substring(user.fullName,0,1)}">A</span>
                                                </div>
                                                <div>
                                                    <p class="font-bold text-dark-ink" th:text="${user.fullName}">Name</p>
                                                    <p class="text-gray-500 text-xs" th:text="${user.email}">email</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="p-4">
                                            <span th:classappend="${user.status.name() == 'ACTIVE' ? 'bg-green-100 text-green-700' : (user.status.name() == 'BLOCKED' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700')}"
                                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                                <span th:text="${user.status}">Status</span>
                                            </span>
                                        </td>
                                        <td class="p-4">
                                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-bold" th:text="${user.role}">Role</span>
                                        </td>
                                        <td class="p-4 text-gray-500" th:text="${#temporals.format(user.createdAt, 'dd MMM yyyy')}">Date</td>
                                        <td class="p-4">
                                            <div class="flex justify-end gap-2">
                                                <form th:if="${user.status.name() != 'BANNED'}" 
                                                      th:action="@{/admin/users/toggle-status/{id}(id=${user.userId})}" method="post">
                                                    <button type="submit" 
                                                            th:classappend="${user.status.name() == 'BLOCKED'} ? 'text-green-600 bg-green-50 hover:bg-green-100' : 'text-orange-600 bg-orange-50 hover:bg-orange-100'"
                                                            class="px-3 py-1.5 rounded text-xs font-bold transition-colors" 
                                                            style="height: 100%">
                                                        <span th:text="${user.status.name() == 'BLOCKED'} ? 'Unlock' : 'Block'">Lock</span>
                                                    </button>
                                                </form>

                                                <form th:if="${user.status.name() != 'BANNED'}" 
                                                      th:id="'ban-form-' + ${user.userId}"
                                                      th:action="@{/admin/users/ban/{id}(id=${user.userId})}" method="post" style="display: none;">
                                                </form>
                                                <button type="button" 
                                                        th:if="${user.status.name() != 'BANNED'}"
                                                        th:onclick="confirmAction('ban-form-[[${user.userId}]]', 'Ban ' + [[${user.fullName}]] + '?', 'This user will be permanently banned.', 'Yes, Ban User')"
                                                        class="px-3 py-1.5 rounded bg-gray-900 text-white text-xs font-bold hover:bg-black transition-colors">
                                                    Ban
                                                </button>

                                                <button type="button"  th:if="${user.status.name() != 'BANNED'}"
                                                        th:onclick="openEditUserModal([[${user.userId}]], [[${user.fullName}]], [[${user.email}]], [[${user.role}]])"
                                                        class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition font-bold"
                                                        title="Edit User">
                                                    Edit
                                                </button>

                                                <span th:if="${user.status.name() == 'BANNED'}" class="text-red-600 font-bold text-xs px-2 py-1">PERMANENT BAN</span>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${users.empty}">
                                        <td colspan="5" class="p-8 text-center text-gray-500">No users found.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t border-gray-100 flex justify-between items-center" th:if="${totalPages > 0}">
                            <span class="text-sm text-gray-500">Page <span th:text="${currentPage}">1</span> of <span th:text="${totalPages}">10</span></span>
                            <div class="flex gap-2">
                                <a th:if="${currentPage > 1}" th:href="@{/admin/users(page=${currentPage - 1}, keyword=${keyword}, role=${role}, status=${status})}" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Previous</a>
                                <a th:if="${currentPage < totalPages}" th:href="@{/admin/users(page=${currentPage + 1}, keyword=${keyword}, role=${role}, status=${status})}" class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Next</a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <dialog id="addUserModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/40 w-full max-w-lg open:animate-fade-in">
                <form th:action="@{/admin/users/add}" method="post" th:object="${newUser}" class="flex flex-col">
                    <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-dark-ink">Add New User</h3>
                        <button type="button" onclick="document.getElementById('addUserModal').close()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="p-6 flex flex-col gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Full Name</label>
                            <input type="text" th:field="*{fullName}" required class="w-full rounded-lg border-gray-300 focus:ring-nutri-green focus:border-nutri-green"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                            <input type="email" th:field="*{email}" required class="w-full rounded-lg border-gray-300 focus:ring-nutri-green focus:border-nutri-green"/>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Password</label>
                            <input type="password" name="rawPassword" required class="w-full rounded-lg border-gray-300 focus:ring-nutri-green focus:border-nutri-green" placeholder="Default password"/>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Role</label>
                                <select th:field="*{role}" class="w-full rounded-lg border-gray-300 focus:ring-nutri-green focus:border-nutri-green">
                                    <option value="USER">USER</option>
                                    <option value="ADMIN">ADMIN</option>
                                    <option value="NUTRITIONIST">NUTRITIONIST</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                                <select th:field="*{status}" class="w-full rounded-lg border-gray-300 focus:ring-nutri-green focus:border-nutri-green">
                                    <option value="ACTIVE">ACTIVE</option>
                                    <option value="PENDING_VERIFICATION">PENDING VERIFICATION</option>
                                    <option value="BLOCKED">BLOCKED</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                        <button type="button" onclick="document.getElementById('addUserModal').close()" class="px-4 py-2 rounded-lg text-gray-600 font-bold hover:bg-gray-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-nutri-green text-white font-bold hover:bg-green-600 shadow-sm">Create User</button>
                    </div>
                </form>
            </dialog>
        </div>

        <dialog id="editUserModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/40 w-full max-w-md">
            <div class="bg-white rounded-xl overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-lg text-dark-ink">Edit User Info</h3>
                    <button onclick="document.getElementById('editUserModal').close()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <form action="/admin/users/update" method="post" class="p-6 space-y-4">
                    <input type="hidden" name="userId" id="editUserId">

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                        <input type="text" id="editUserEmail" class="w-full bg-gray-100 text-gray-500 border-gray-200 rounded-lg focus:ring-0 cursor-not-allowed" readonly>
                    </div>

                    <div>   
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                        <input type="text" name="fullName" id="editUserFullName" required
                               class="w-full border-gray-200 rounded-lg focus:ring-nutri-green focus:border-nutri-green">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Role</label>
                        <select name="role" id="editUserRole" class="w-full border-gray-200 rounded-lg focus:ring-nutri-green focus:border-nutri-green">
                            <option th:each="r : ${allRoles}" th:value="${r}" th:text="${r}"></option>
                        </select>
                    </div>

                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" onclick="document.getElementById('editUserModal').close()" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-bold hover:bg-blue-700 rounded-lg shadow-sm">Save Changes</button>
                    </div>
                </form>
            </div>
        </dialog>

        <div th:replace="~{fragments/toast :: toast-system}"></div>
        <script>
            function confirmAction(formId, title = 'Are you sure?', text = "You won't be able to revert this!", confirmBtnText = 'Yes, do it!') {
                Swal.fire({
                    title: title,
                    text: text,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#111827',
                    cancelButtonColor: '#d33',
                    confirmButtonText: confirmBtnText,
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Hiển thị loading trước khi submit
                        ZaderToast.loading('Processing...');
                        const form = document.getElementById(formId);
                        if (form) {
                            form.submit();
                        } else {
                            console.error('Form not found: ' + formId);
                            ZaderToast.error('Error: Form ID not found');
                        }
                    }
                }
                );
            }

            function openEditUserModal(id, fullName, email, role) {
                // 1. Lấy các thẻ input
                const modal = document.getElementById('editUserModal');
                const idInput = document.getElementById('editUserId');
                const nameInput = document.getElementById('editUserFullName');
                const emailInput = document.getElementById('editUserEmail');
                const roleSelect = document.getElementById('editUserRole');

                // 2. Điền dữ liệu vào form
                idInput.value = id;
                nameInput.value = fullName;
                emailInput.value = email;
                roleSelect.value = role;

                // 3. Hiển thị Modal
                modal.showModal();
            }
        </script>
    </body>
</html>