<!DOCTYPE html>
<html class="light" lang="en" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{fragments/head :: common-head}">
        <title>Account Settings - Zader Food</title> 
    </head>

    <body class="font-display bg-smart-white dark:bg-background-dark text-dark-ink">

    <th:block th:replace="~{fragments/toast :: toast-system}"></th:block>

    <th:block th:replace="~{fragments/navbar :: header_nav}"></th:block>

    <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">

        <main class="flex h-full grow flex-col py-10 md:py-20">
            <div class="container mx-auto px-4">
                <div class="mx-auto flex max-w-5xl flex-col gap-8">
                    <h1 class="text-dark-ink text-4xl font-black leading-tight tracking-[-0.033em] text-center">Personal Settings</h1>

                    <div th:if="${successMessage}" class="hidden p-4 mb-2 text-sm text-green-800 rounded-lg bg-green-50 flex items-center gap-2" role="alert">
                        <span class="material-symbols-outlined text-lg">check_circle</span>
                        <div><span class="font-medium">Success!</span> <span th:text="${successMessage}"></span></div>
                    </div>

                    <div class="bg-card-white rounded-xl shadow-subtle p-6 md:p-10">
                        <form th:action="@{/user/settings}" th:object="${userProfileDTO}" method="post">
                            <div class="flex flex-col gap-10">

                                <div class="flex flex-col gap-6">
                                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-4">
                                        <div>
                                            <h3 class="text-dark-ink text-xl font-bold leading-tight">Nutritional Goal & Overview</h3>
                                            <p class="text-soft-grey text-sm mt-1">Managed by our AI Calculator based on your body metrics.</p>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div class="relative overflow-hidden rounded-xl bg-gradient-to-br from-chef-orange/5 to-chef-orange/10 border border-chef-orange/20 p-6">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="p-2 bg-white rounded-full shadow-sm text-chef-orange">
                                                    <span class="material-symbols-outlined text-xl block">flag</span>
                                                </div>
                                                <span class="text-sm font-bold text-dark-ink uppercase tracking-wider">Daily Target</span>
                                            </div>
                                            <div class="flex items-baseline gap-1 mt-2">
                                                <input type="number" th:field="*{calorieGoalPerDay}" 
                                                       class="bg-transparent border-0 border-b-2 border-chef-orange/50 focus:border-chef-orange focus:ring-0 text-3xl font-black text-chef-orange w-32 p-0 m-0 leading-none placeholder-chef-orange/30" 
                                                       placeholder="2000">
                                                <span class="text-sm font-medium text-soft-grey">kcal</span>
                                            </div>
                                            <p class="text-xs text-soft-grey mt-3">Target calories to achieve your goal.</p>
                                        </div>

                                        <div class="relative overflow-hidden rounded-xl bg-gray-50 border border-gray-200 p-6">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="p-2 bg-white rounded-full shadow-sm text-protein-blue">
                                                    <span class="material-symbols-outlined text-xl block">local_fire_department</span>
                                                </div>
                                                <span class="text-sm font-bold text-soft-grey uppercase tracking-wider">TDEE (Maintenance)</span>
                                            </div>
                                            <div class="flex items-baseline gap-1 mt-2">
                                                <span class="text-2xl font-bold text-dark-ink" th:text="${userProfileDTO.tdee != null ? userProfileDTO.tdee : '---'}">---</span>
                                                <span class="text-xs font-medium text-soft-grey">kcal</span>
                                            </div>
                                            <p class="text-xs text-soft-grey mt-3">Energy you burn daily.</p>
                                            <input type="hidden" th:field="*{tdee}">
                                        </div>

                                        <div class="relative overflow-hidden rounded-xl bg-gray-50 border border-gray-200 p-6">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="p-2 bg-white rounded-full shadow-sm text-purple-500">
                                                    <span class="material-symbols-outlined text-xl block">vital_signs</span>
                                                </div>
                                                <span class="text-sm font-bold text-soft-grey uppercase tracking-wider">BMR (Basal Rate)</span>
                                            </div>
                                            <div class="flex items-baseline gap-1 mt-2">
                                                <span class="text-2xl font-bold text-dark-ink" th:text="${userProfileDTO.bmr != null ? userProfileDTO.bmr : '---'}">---</span>
                                                <span class="text-xs font-medium text-soft-grey">kcal</span>
                                            </div>
                                            <p class="text-xs text-soft-grey mt-3">Energy burned at rest.</p>
                                            <input type="hidden" th:field="*{bmr}">
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-6 pt-8 border-t border-gray-100">
                                    <h3 class="text-dark-ink text-lg font-bold leading-tight">Personal Information</h3>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Full Name</span>
                                            <input th:field="*{fullName}" class="form-input flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist h-12 px-4 focus:border-primary focus:ring-1 focus:ring-primary" />
                                        </label>
                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Email Address</span>
                                            <input th:field="*{email}" readonly class="form-input flex w-full rounded-lg text-soft-grey bg-gray-100 border border-smart-mist h-12 px-4 cursor-not-allowed" />
                                        </label>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <label class="flex flex-col gap-2 md:col-span-2">
                                            <span class="text-dark-ink text-sm font-medium">Date of Birth</span>
                                            <input type="date" th:field="*{birthDate}" class="form-input flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist h-12 px-4 focus:border-primary focus:ring-1 focus:ring-primary" />
                                        </label>
                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Gender</span>
                                            <select th:field="*{gender}" class="form-select flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist h-12 px-4 focus:border-primary focus:ring-1 focus:ring-primary">
                                                <option value="">Select</option>
                                                <option value="MALE">Male</option>
                                                <option value="FEMALE">Female</option>
                                                <option value="OTHER">Other</option>
                                            </select>
                                        </label>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Weight (Kg)</span>
                                            <input type="number" step="0.1" th:field="*{weightKg}" class="form-input flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist h-12 px-4 focus:border-primary focus:ring-1 focus:ring-primary" />
                                        </label>
                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Height (Cm)</span>
                                            <input type="number" step="0.1" th:field="*{heightCm}" class="form-input flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist h-12 px-4 focus:border-primary focus:ring-1 focus:ring-primary" />
                                        </label>
                                    </div>
                                </div>

                                <div class="mt-6 p-6 bg-blue-50/50 rounded-xl border border-blue-100 relative">
                                    <h4 class="font-bold text-dark-ink text-sm uppercase tracking-wide mb-4 flex items-center gap-2">
                                        <span class="material-symbols-outlined text-blue-600">flag</span> Specific Goal Setting
                                    </h4>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6"> <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Target Weight (Kg)</span>
                                            <input type="number" step="0.1" th:field="*{targetWeightKg}" id="targetWeightInput"
                                                   class="form-input rounded-lg border-smart-mist h-12 px-4 focus:border-blue-500 focus:ring-blue-500" 
                                                   placeholder="e.g. 65.5"/>
                                        </label>

                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Start Date</span>
                                            <input type="date" th:field="*{startDate}" id="startDateInput"
                                                   class="form-input rounded-lg border-smart-mist h-12 px-4 focus:border-blue-500 focus:ring-blue-500" />
                                        </label>

                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Target Date</span>
                                            <input type="date" th:field="*{targetDate}" id="targetDateInput"
                                                   class="form-input rounded-lg border-smart-mist h-12 px-4 focus:border-blue-500 focus:ring-blue-500" />
                                        </label>
                                    </div>

                                    <div id="goalWarning" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm flex items-start gap-2">
                                        <span class="material-symbols-outlined text-lg mt-0.5">warning</span>
                                        <div>
                                            <strong class="block font-bold">Unrealistic Goal Warning!</strong>
                                            <span id="goalWarningText">You are trying to lose weight too fast.</span>
                                        </div>
                                    </div>

                                    <div id="goalInfo" class="hidden mt-4 p-3 bg-green-100 text-green-700 rounded-lg text-sm flex items-start gap-2 flex items-center">
                                        <span class="material-symbols-outlined text-lg mt-0.5">info</span>
                                        <span id="goalInfoText">Normal pace.</span>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-6 pt-8 border-t border-gray-100">
                                    <div class="flex flex-col gap-2">
                                        <h3 class="text-dark-ink text-lg font-bold leading-tight">Dietary Preferences</h3>
                                        <p class="text-soft-grey text-sm">Select all that apply to help us suggest better recipes.</p>
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <th:block th:each="type : ${allDietTypes}">
                                            <label class="cursor-pointer relative group">
                                                <input type="checkbox" th:field="*{dietaryPreferences}" th:value="${type}" class="peer sr-only"/>
                                                <span class="flex items-center justify-center rounded-full border border-smart-mist bg-white px-4 py-2 text-sm font-medium text-soft-grey transition-all 
                                                      peer-checked:bg-nutri-green peer-checked:text-white peer-checked:border-nutri-green peer-checked:shadow-md
                                                      group-hover:border-nutri-green/50">
                                                    <span th:text="${#strings.capitalize(#strings.toLowerCase(type.name().replace('_', ' ')))}">Diet Name</span>
                                                </span>
                                            </label>
                                        </th:block>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-6 pt-8 border-t border-gray-100">
                                    <div class="flex flex-col gap-2">
                                        <h3 class="text-dark-ink text-lg font-bold leading-tight">Activity Level</h3>
                                        <p class="text-soft-grey text-sm">
                                            How active are you on a daily basis?
                                        </p>
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <th:block th:each="level : ${allActivityLevels}">
                                            <label class="cursor-pointer relative group"
                                                   onmouseover="showDescription(this.getAttribute('data-type'), 'activity-helper')"
                                                   onmouseout="clearDescription('activity-helper')"
                                                   th:attr="data-type=${level.name()}">

                                                <input type="radio" th:field="*{activityLevel}" th:value="${level}" class="peer sr-only"/>

                                                <span class="flex items-center justify-center rounded-full border border-smart-mist bg-white px-4 py-2 text-sm font-medium text-soft-grey transition-all 
                                                      peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600 peer-checked:shadow-md
                                                      group-hover:border-purple-600/50 group-hover:text-purple-600">
                                                    <span th:text="${#strings.capitalize(#strings.toLowerCase(level.name().replace('_', ' ')))}">Level Name</span>
                                                </span>
                                            </label>
                                        </th:block>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-6 pt-8 border-t border-gray-100">
                                    <div class="flex flex-col gap-2">
                                        <h3 class="text-dark-ink text-lg font-bold leading-tight">Primary Goal</h3>
                                        <p class="text-soft-grey text-sm">Select your main objective to help AI calculate better plans.</p>
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <th:block th:each="goalItem : ${allGoals}">
                                            <label class="cursor-pointer relative group">
                                                <input type="radio" th:field="*{goal}" th:value="${goalItem}" class="peer sr-only"/>

                                                <span class="flex items-center justify-center rounded-full border border-smart-mist bg-white px-4 py-2 text-sm font-medium text-soft-grey transition-all 
                                                      peer-checked:bg-chef-orange peer-checked:text-white peer-checked:border-chef-orange peer-checked:shadow-md
                                                      group-hover:border-chef-orange/50">

                                                    <span th:text="${#strings.capitalize(#strings.toLowerCase(goalItem.name().replace('_', ' ')))}">Goal Name</span>
                                                </span>
                                            </label>
                                        </th:block>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-6 pt-8 border-t border-gray-100">
                                    <h3 class="text-dark-ink text-lg font-bold leading-tight">Allergies & Notes</h3>
                                    <label class="flex flex-col gap-2">
                                        <span class="text-dark-ink text-sm font-medium">Allergies (Separated by comma)</span>
                                        <textarea th:field="*{allergies}" rows="3" placeholder="e.g. Peanuts, Shellfish, Dairy..." 
                                                  class="form-input flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist p-4 focus:border-primary focus:ring-1 focus:ring-primary"></textarea>
                                    </label>

                                    <div class="pt-8 flex flex-col sm:flex-row-reverse gap-4">
                                        <button type="submit" class="flex w-full sm:w-auto min-w-[120px] cursor-pointer items-center justify-center rounded-lg h-12 px-6 bg-chef-orange text-white text-base font-bold shadow-lg shadow-chef-orange/20 hover:bg-chef-orange/90 hover:shadow-xl transition-all">
                                            Save Changes
                                        </button>
                                        <button type="reset" class="flex w-full sm:w-auto min-w-[100px] cursor-pointer items-center justify-center rounded-lg h-12 px-6 bg-gray-100 text-soft-grey text-base font-bold hover:bg-gray-200 transition-all">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                        </form>

                        <div id="security-section" class="border-t border-gray-200 pt-10 mt-10">
                            <h3 class="text-dark-ink text-lg font-bold mb-6 flex items-center gap-2">
                                <span class="material-symbols-outlined text-soft-grey">lock</span>
                                Security & Password
                            </h3>
                            <form th:action="@{/user/change-password}" th:object="${changePasswordDTO}" method="post">
                                <div class="flex flex-col gap-6">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Current Password</span>
                                            <input type="password" th:field="*{currentPassword}" required class="form-input flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist h-12 px-4 focus:border-primary focus:ring-1 focus:ring-primary" placeholder="••••••••"/>
                                        </label>
                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">New Password</span>
                                            <input type="password" th:field="*{newPassword}" required class="form-input flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist h-12 px-4 focus:border-primary focus:ring-1 focus:ring-primary" placeholder="••••••••"/>
                                        </label>
                                        <label class="flex flex-col gap-2">
                                            <span class="text-dark-ink text-sm font-medium">Confirm Password</span>
                                            <input type="password" th:field="*{confirmPassword}" required class="form-input flex w-full rounded-lg text-dark-ink bg-card-white border border-smart-mist h-12 px-4 focus:border-primary focus:ring-1 focus:ring-primary" placeholder="••••••••"/>
                                        </label>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" class="flex w-full sm:w-auto cursor-pointer items-center justify-center rounded-lg h-12 px-6 bg-dark-ink text-white text-base font-bold hover:bg-black transition-all">
                                            Update Password
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>  
                    </div>
                </div>
            </div>
        </main>

        <th:block th:replace="~{fragments/footer :: footer_section}"></th:block>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            /* * NHẬN DỮ LIỆU TỪ CONTROLLER
             * Thymeleaf sẽ điền giá trị vào các biến này khi render server-side
             */
            const msgSuccess = /*[[${success}]]*/ null;      // Lấy từ redirectAttributes.addFlashAttribute("success",...)
            const msgError = /*[[${error}]]*/ null;          // Lấy từ redirectAttributes.addFlashAttribute("error",...)
            const swalData = /*[[${swal}]]*/ null;           // Lấy data SweetAlert nếu có

            // 1. XỬ LÝ TOAST (Thông báo góc phải)
            if (msgSuccess) {
                // Nếu ZaderToast đã được define ở file toast.html
                if (typeof ZaderToast !== 'undefined') {
                    ZaderToast.success(msgSuccess);
                } else {
                    console.warn("ZaderToast chưa được load");
                }
            }

            if (msgError) {
                if (typeof ZaderToast !== 'undefined') {
                    ZaderToast.error(msgError);
                }
            }

            // 2. XỬ LÝ SWEETALERT (Popup to giữa màn hình)
            // Dùng cái này khi muốn thông báo quan trọng (VD: Đổi pass xong bắt đăng nhập lại)
            if (swalData) {
                Swal.fire({
                    title: swalData.title || 'Thông báo',
                    text: swalData.text || '',
                    icon: swalData.icon || 'info',
                    confirmButtonColor: '#FF7043', // Màu Chef Orange
                    confirmButtonText: 'OK'
                });
            }
        });

        // --- TỪ ĐIỂN MÔ TẢ (DESCRIPTIONS) ---
        const DESCRIPTIONS = {
            // GOALS
            'MAINTENANCE': 'Maintain your current weight. Best for staying fit without size changes.',
            'WEIGHT_LOSS': 'Create a calorie deficit to lose body fat while retaining muscle.',
            'MUSCLE_GAIN': 'Create a calorie surplus to build muscle mass (requires strength training).',
            'WEIGHT_GAIN': 'Increase overall body weight (muscle + fat) for those who are underweight.',

            // DIETS
            'BALANCED': 'No food restrictions. Focus on variety and moderation.',
            'VEGAN': 'Excludes all animal products (meat, dairy, eggs, honey).',
            'VEGETARIAN': 'Excludes meat and fish but allows dairy and eggs.',
            'KETO': 'High fat, very low carb. Forces body into ketosis to burn fat.',
            'LOW_CARB': 'Reduces carbohydrate intake, focusing on protein and veggies.',
            'EAT_CLEAN': 'Focus on whole, unprocessed foods. No added sugar or refined carbs.',
            'HIGH_PROTEIN': 'Emphasizes protein intake for muscle repair and satiety.',
            'GLUTEN_FREE': 'Excludes gluten (wheat, barley, rye). Essential for Celiac disease.',
            'DAIRY_FREE': 'Excludes milk and dairy products. Good for lactose intolerance.'
        };

        function showDescription(type, elementId) {
            const descElement = document.getElementById(elementId);
            if (DESCRIPTIONS[type]) {
                descElement.textContent = DESCRIPTIONS[type];
                descElement.classList.remove('opacity-0');
            }
        }

        function clearDescription(elementId) {
            const descElement = document.getElementById(elementId);
            // Có thể để trống hoặc reset về câu mặc định
            descElement.textContent = 'Hover over an option to see details.';
            descElement.classList.add('text-gray-400');
        }
    </script>
    <script>
        // --- LOGIC CẢNH BÁO MỤC TIÊU ---
        const currentWeightInput = document.getElementById('weightKg'); // Đảm bảo input cân nặng có id="weightKg"
        const targetWeightInput = document.getElementById('targetWeightInput');
        const targetDateInput = document.getElementById('targetDateInput');
        const warningBox = document.getElementById('goalWarning');
        const warningText = document.getElementById('goalWarningText');
        const infoBox = document.getElementById('goalInfo');
        const infoText = document.getElementById('goalInfoText');

        function checkGoalFeasibility() {
            const currentW = parseFloat(currentWeightInput.value);
            const targetW = parseFloat(targetWeightInput.value);
            const targetDateVal = targetDateInput.value;

            if (!currentW || !targetW || !targetDateVal) {
                warningBox.classList.add('hidden');
                infoBox.classList.add('hidden');
                return;
            }

            const today = new Date();
            const tDate = new Date(targetDateVal);
            const diffTime = tDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays <= 0) {
                warningBox.classList.remove('hidden');
                warningText.textContent = "Target date must be in the future.";
                infoBox.classList.add('hidden');
                return;
            }

            const diffWeight = targetW - currentW; // Âm = Giảm cân, Dương = Tăng cân
            const weeks = diffDays / 7;
            const ratePerWeek = Math.abs(diffWeight) / weeks;

            // Reset UI
            warningBox.classList.add('hidden');
            infoBox.classList.add('hidden');

            // LOGIC KIỂM TRA
            // 1. Giảm cân quá nhanh (> 1kg/tuần là khó và hại sức khỏe)
            if (diffWeight < 0 && ratePerWeek > 1.0) {
                warningBox.classList.remove('hidden');
                warningText.textContent = `You are aiming to lose ${ratePerWeek.toFixed(1)} kg/week. Safe rate is 0.5 - 1.0 kg/week. This requires extreme calorie deficit.`;
            }
            // 2. Tăng cân quá nhanh (> 0.5kg/tuần chủ yếu là mỡ)
            else if (diffWeight > 0 && ratePerWeek > 0.5) {
                warningBox.classList.remove('hidden');
                warningText.textContent = `You are aiming to gain ${ratePerWeek.toFixed(1)} kg/week. It's hard to build muscle that fast; you might gain mostly fat.`;
            }
            // 3. Bình thường
            else {
                infoBox.classList.remove('hidden');
                const type = diffWeight < 0 ? "lose" : "gain";
                infoText.textContent = `This is a healthy goal! You will ${type} about ${ratePerWeek.toFixed(2)} kg/week.`;
            }
        }

        // Gắn sự kiện lắng nghe thay đổi
        if (currentWeightInput)
            currentWeightInput.addEventListener('input', checkGoalFeasibility);
        if (targetWeightInput)
            targetWeightInput.addEventListener('input', checkGoalFeasibility);
        if (targetDateInput)
            targetDateInput.addEventListener('input', checkGoalFeasibility);

        // [THÊM DÒNG NÀY] Chạy kiểm tra ngay khi load trang để hiện cảnh báo/info
        checkGoalFeasibility();
    </script>
</body>
</html>

</body>
</html>